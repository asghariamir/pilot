<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Function Behavior Explorer | Mathswell</title>
  <link rel="icon" href="/logo-mathswell-square-mirror.ico" type="image/x-icon">
  <link rel="icon" href="/logo-mathswell-square-mirror.svg" type="image/svg+xml">
  <style>
    :root {
      --primary: #0f766e;
      --primary-light: #10b981;
      --primary-dark: #0a5a52;
      --background: #f7faf9;
      --interactive: #e6fffb;
      --text-primary: #212121;
      --text-muted: #4b5563;
      --accent-amber: #f59e0b;
      --accent-red: #dc2626;
      --accent-blue: #2563eb;
      --surface: #ffffff;
      --border: #e0e7e4;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #dc2626;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, var(--background) 0%, #f0f9f8 100%);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }

    .mathswell-nav {
      display: flex;
      justify-content: center;
      margin: 1.5rem 0;
      padding: 0.5rem;
    }

    .mw-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
      font-weight: 700;
      color: var(--primary);
      padding: 0.5rem 1rem;
      border-radius: 999px;
      background: #fff;
      box-shadow: 0 2px 8px rgba(15, 118, 110, 0.1);
      transition: all 0.3s ease;
    }

    .mw-link:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(15, 118, 110, 0.2);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      background: white;
      border-radius: 12px;
      padding: 0.5rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      justify-content: center;
    }

    .tab-btn {
      padding: 0.75rem 1.5rem;
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 8px;
      flex: 1;
      max-width: 200px;
    }

    .tab-btn:hover {
      background: var(--interactive);
      color: var(--primary);
    }

    .tab-btn.active {
      color: white;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      box-shadow: 0 2px 8px rgba(15, 118, 110, 0.15);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .hero {
      background: linear-gradient(135deg, #fff, var(--interactive));
      padding: 2.5rem;
      border-radius: 16px;
      margin-bottom: 2rem;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      text-align: center;
    }

    .hero h1 {
      color: var(--primary);
      margin-bottom: 1rem;
      font-size: 2.2rem;
      font-weight: 700;
    }

    .hero p {
      color: var(--text-muted);
      font-size: 1.1rem;
      max-width: 700px;
      margin: 0 auto;
    }

    .concept-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .concept-card {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }

    .concept-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }

    .concept-card h3 {
      color: var(--primary);
      margin-bottom: 0.75rem;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .concept-card .icon {
      font-size: 1.5rem;
    }

    .concept-card p {
      color: var(--text-muted);
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
    }

    .concept-card .formula {
      background: var(--interactive);
      padding: 0.5rem;
      border-radius: 6px;
      text-align: center;
      font-family: 'Monaco', monospace;
      color: var(--primary-dark);
    }

    .interactive-demo {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      margin-bottom: 2rem;
    }

    .interactive-demo h3 {
      color: var(--primary);
      margin-bottom: 1rem;
      text-align: center;
    }

    .demo-canvas {
      width: 100%;
      height: 300px;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: white;
      margin-bottom: 1rem;
    }

    .demo-controls {
      display: flex;
      gap: 0.75rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .demo-btn {
      padding: 0.5rem 1rem;
      background: white;
      border: 2px solid var(--primary);
      border-radius: 999px;
      color: var(--primary);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .demo-btn:hover,
    .demo-btn.active {
      background: var(--interactive);
      transform: translateY(-2px);
    }

    /* Graph Reading Tab */
    .graph-display {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      margin-bottom: 2rem;
    }

    .graph-display h3 {
      color: var(--primary);
      margin-bottom: 1rem;
      text-align: center;
      font-size: 1.3rem;
    }

    .graph-canvas {
      width: 100%;
      height: 350px;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: white;
    }

    .behavior-bank {
      background: linear-gradient(135deg, var(--interactive), #f8fffe);
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    }

    .behavior-bank h3 {
      color: var(--primary);
      margin-bottom: 1rem;
      text-align: center;
    }

    .behavior-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 0.75rem;
    }

    .behavior-card {
      padding: 0.75rem;
      background: white;
      border: 2px solid var(--primary);
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 600;
      color: var(--primary);
      user-select: none;
    }

    .behavior-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(15, 118, 110, 0.2);
      background: var(--interactive);
    }

    .behavior-card.selected {
      background: var(--primary);
      color: white;
    }

    .description-area {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      margin-bottom: 2rem;
    }

    .description-area h3 {
      color: var(--primary);
      margin-bottom: 1rem;
      text-align: center;
    }

    .description-sequence {
      min-height: 100px;
      padding: 1rem;
      background: var(--interactive);
      border: 2px dashed var(--primary);
      border-radius: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      justify-content: center;
    }

    .sequence-item {
      padding: 0.5rem 1rem;
      background: white;
      border: 2px solid var(--primary);
      border-radius: 999px;
      font-weight: 600;
      color: var(--primary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .sequence-item:hover {
      background: #fee;
      border-color: var(--error);
      color: var(--error);
    }

    .placeholder {
      color: var(--text-muted);
      font-style: italic;
    }

    /* Build Tab */
    .challenge-display {
      background: linear-gradient(135deg, #fffbeb, #fef3c7);
      padding: 2rem;
      border-radius: 12px;
      border: 2px solid var(--accent-amber);
      margin-bottom: 2rem;
      text-align: center;
    }

    .challenge-display h3 {
      color: #92400e;
      margin-bottom: 0.75rem;
      font-size: 1.2rem;
    }

    .challenge-text {
      color: #451a03;
      font-size: 1.3rem;
      font-weight: 600;
    }

    .builder-workspace {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      margin-bottom: 2rem;
    }

    .builder-workspace h3 {
      color: var(--primary);
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .drawing-canvas {
      width: 100%;
      height: 400px;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: white;
      cursor: crosshair;
      position: relative;
    }

    .tool-palette {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: var(--interactive);
      border-radius: 8px;
    }

    .tool-btn {
      padding: 1rem;
      background: white;
      border: 2px solid var(--primary);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }

    .tool-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(15, 118, 110, 0.2);
    }

    .tool-btn.active {
      background: var(--primary);
      color: white;
    }

    .tool-icon {
      width: 60px;
      height: 40px;
    }

    .tool-label {
      font-size: 0.85rem;
      font-weight: 600;
    }

    .controls {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.95rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      box-shadow: 0 2px 4px rgba(15, 118, 110, 0.2);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(15, 118, 110, 0.3);
    }

    .btn-secondary {
      background: white;
      color: var(--primary);
      border: 2px solid var(--primary);
    }

    .btn-secondary:hover {
      background: var(--interactive);
    }

    .feedback {
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
      display: none;
      border-left: 4px solid;
      text-align: center;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .feedback.show {
      display: block;
    }

    .feedback.success {
      background: #d4edda;
      color: #155724;
      border-left-color: var(--success);
    }

    .feedback.error {
      background: #f8d7da;
      color: #721c24;
      border-left-color: var(--error);
    }

    .feedback.info {
      background: #cce5ff;
      color: #004085;
      border-left-color: var(--accent-blue);
    }

    .cta-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 2rem;
    }

    @media (max-width: 768px) {
      .tabs {
        flex-direction: column;
      }
      
      .tab-btn {
        max-width: 100%;
      }
      
      .concept-cards {
        grid-template-columns: 1fr;
      }
      
      .behavior-cards {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }
    }
  </style>
</head>
<body>
  <div class="mathswell-nav">
    <a href="/" class="mw-link">
      <img src="/logo-mathswell-square-mirror.svg" alt="Mathswell" width="28" height="28">
      <span>MATHSWELL</span>
    </a>
  </div>

  <div class="container">
    <div class="tabs">
      <button class="tab-btn active" data-tab="intro">Introduction</button>
      <button class="tab-btn" data-tab="read">Graph Reading</button>
      <button class="tab-btn" data-tab="build">Function Builder</button>
    </div>

    <!-- Introduction Tab -->
    <div id="intro" class="tab-content active">
      <div class="hero">
        <h1>Function Behavior Explorer</h1>
        <p>Master the art of analyzing and creating functions by understanding their fundamental behaviors. Learn to read graphs like a mathematician and build functions from descriptions.</p>
      </div>

      <div class="concept-cards">
        <div class="concept-card">
          <h3><span class="icon">üìà</span> Direction</h3>
          <p>Functions can be increasing (going up), decreasing (going down), or constant (staying flat).</p>
          <div class="formula">f'(x) > 0 ‚Üí Increasing</div>
        </div>
        <div class="concept-card">
          <h3><span class="icon">üåä</span> Curvature</h3>
          <p>Functions curve up (like a smile ‚à™) or down (like a frown ‚à©), determined by the second derivative.</p>
          <div class="formula">f''(x) > 0 ‚Üí Concave Up</div>
        </div>
        <div class="concept-card">
          <h3><span class="icon">üîÑ</span> Special Points</h3>
          <p>Inflection points change concavity, corners change direction sharply, and jumps create discontinuities.</p>
          <div class="formula">f''(x) = 0 ‚Üí Possible Inflection</div>
        </div>
      </div>

      <div class="interactive-demo">
        <h3>Try It: Click to See Different Behaviors</h3>
        <canvas id="demo-canvas" class="demo-canvas"></canvas>
        <div class="demo-controls">
          <button class="demo-btn" onclick="showDemo('increasing')">Increasing</button>
          <button class="demo-btn" onclick="showDemo('decreasing')">Decreasing</button>
          <button class="demo-btn" onclick="showDemo('concave-up')">Concave Up</button>
          <button class="demo-btn" onclick="showDemo('concave-down')">Concave Down</button>
          <button class="demo-btn" onclick="showDemo('inflection')">Inflection</button>
          <button class="demo-btn" onclick="showDemo('corner')">Corner</button>
        </div>
      </div>

      <div class="cta-buttons">
        <button class="btn btn-primary" onclick="switchToTab('read')">Practice Reading Graphs ‚Üí</button>
        <button class="btn btn-primary" onclick="switchToTab('build')">Build Functions ‚Üí</button>
      </div>
    </div>

    <!-- Graph Reading Tab -->
    <div id="read" class="tab-content">
      <div class="graph-display">
        <h3>üìñ Describe This Function</h3>
        <canvas id="read-canvas" class="graph-canvas"></canvas>
        <div class="controls">
          <button class="btn btn-secondary" onclick="generateNewGraph()">New Graph</button>
        </div>
      </div>

      <div class="behavior-bank">
        <h3>Available Behaviors</h3>
        <p style="text-align: center; color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">
          Click behaviors to describe the function from left to right
        </p>
        <div class="behavior-cards" id="behavior-cards">
          <div class="behavior-card" onclick="addBehavior('increasing')">Increasing</div>
          <div class="behavior-card" onclick="addBehavior('decreasing')">Decreasing</div>
          <div class="behavior-card" onclick="addBehavior('constant')">Constant</div>
          <div class="behavior-card" onclick="addBehavior('concave-up')">Concave Up</div>
          <div class="behavior-card" onclick="addBehavior('concave-down')">Concave Down</div>
          <div class="behavior-card" onclick="addBehavior('linear')">Linear</div>
          <div class="behavior-card" onclick="addBehavior('inflection')">Inflection</div>
          <div class="behavior-card" onclick="addBehavior('corner')">Corner</div>
          <div class="behavior-card" onclick="addBehavior('jump')">Jump</div>
        </div>
      </div>

      <div class="description-area">
        <h3>Your Description</h3>
        <p style="text-align: center; color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">
          Click items to remove them
        </p>
        <div class="description-sequence" id="description-sequence">
          <div class="placeholder">Add behaviors to describe the function...</div>
        </div>
        <div class="controls">
          <button class="btn btn-primary" onclick="checkDescription()">Check Answer</button>
          <button class="btn btn-secondary" onclick="clearDescription()">Clear</button>
          <button class="btn btn-secondary" onclick="getHint()">Get Hint</button>
        </div>
        <div class="feedback" id="read-feedback"></div>
      </div>
    </div>

    <!-- Function Builder Tab -->
    <div id="build" class="tab-content">
      <div class="challenge-display">
        <h3>üî® Build This Function:</h3>
        <div class="challenge-text" id="challenge-text">
          A function that increases and is concave up
        </div>
        <div class="controls">
          <button class="btn btn-secondary" onclick="newChallenge()">New Challenge</button>
        </div>
      </div>

      <div class="builder-workspace">
        <h3>Drawing Tools</h3>
        <div class="tool-palette">
          <div class="tool-btn" onclick="selectTool('inc-linear')" data-tool="inc-linear">
            <canvas class="tool-icon" id="icon-inc-linear"></canvas>
            <span class="tool-label">Increasing Linear</span>
          </div>
          <div class="tool-btn" onclick="selectTool('dec-linear')" data-tool="dec-linear">
            <canvas class="tool-icon" id="icon-dec-linear"></canvas>
            <span class="tool-label">Decreasing Linear</span>
          </div>
          <div class="tool-btn" onclick="selectTool('inc-up')" data-tool="inc-up">
            <canvas class="tool-icon" id="icon-inc-up"></canvas>
            <span class="tool-label">Increasing ‚à™</span>
          </div>
          <div class="tool-btn" onclick="selectTool('inc-down')" data-tool="inc-down">
            <canvas class="tool-icon" id="icon-inc-down"></canvas>
            <span class="tool-label">Increasing ‚à©</span>
          </div>
          <div class="tool-btn" onclick="selectTool('dec-up')" data-tool="dec-up">
            <canvas class="tool-icon" id="icon-dec-up"></canvas>
            <span class="tool-label">Decreasing ‚à™</span>
          </div>
          <div class="tool-btn" onclick="selectTool('dec-down')" data-tool="dec-down">
            <canvas class="tool-icon" id="icon-dec-down"></canvas>
            <span class="tool-label">Decreasing ‚à©</span>
          </div>
          <div class="tool-btn" onclick="selectTool('constant')" data-tool="constant">
            <canvas class="tool-icon" id="icon-constant"></canvas>
            <span class="tool-label">Constant</span>
          </div>
        </div>

        <h3>Your Function (Click to draw segments)</h3>
        <canvas id="build-canvas" class="drawing-canvas"></canvas>
        <div class="controls">
          <button class="btn btn-primary" onclick="checkBuiltFunction()">Check with AI</button>
          <button class="btn btn-secondary" onclick="clearCanvas()">Clear</button>
          <button class="btn btn-secondary" onclick="undoLastSegment()">Undo</button>
        </div>
        <div class="feedback" id="build-feedback"></div>
      </div>
    </div>
  </div>

  <script>
    // Global state
    const state = {
      // Read tab
      currentGraph: null,
      userDescription: [],
      hintLevel: 0,
      
      // Build tab
      currentChallenge: null,
      selectedTool: 'inc-linear',
      drawnSegments: [],
      attemptCount: 0
    };

    // Graph problems for Read tab - FIXED with correct descriptions
    const graphProblems = [
      {
        id: 'parabola-up',
        behaviors: ['increasing', 'concave-up'],
        description: 'An increasing function that curves upward (like x¬≤)',
        hints: [
          'Look at the overall direction - is it going up or down?',
          'Check the curvature - does it curve like a smile (‚à™) or frown (‚à©)?',
          'This is increasing and concave up throughout'
        ],
        draw: (ctx, w, h) => {
          ctx.beginPath();
          for (let x = 0; x < w; x += 5) {
            const t = (x - w/2) / (w/3);
            const y = h/2 - 100 * Math.pow(t, 2) + 150;
            if (x === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          }
          ctx.stroke();
        }
      },
      {
        id: 'cubic-inflection',
        behaviors: ['increasing', 'concave-down', 'inflection', 'increasing', 'concave-up'],
        description: 'An S-curve that changes concavity at the center',
        hints: [
          'This function is always increasing (going up)',
          'Notice the orange dot - that marks where concavity changes',
          'Before the dot: increasing and concave down, after: increasing and concave up'
        ],
        draw: (ctx, w, h) => {
          ctx.beginPath();
          for (let x = 0; x < w; x += 5) {
            const t = (x - w/2) / (w/3);
            const y = h/2 - 50 * t - 30 * Math.pow(t, 3);
            if (x === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          }
          ctx.stroke();
          // Inflection point
          ctx.fillStyle = '#f59e0b';
          ctx.beginPath();
          ctx.arc(w/2, h/2, 6, 0, 2 * Math.PI);
          ctx.fill();
        }
      },
      {
        id: 'v-shape',
        behaviors: ['decreasing', 'linear', 'corner', 'increasing', 'linear'],
        description: 'A V-shaped function with a corner at the bottom',
        hints: [
          'The function has two linear pieces',
          'Look for the sharp point at the bottom - that\'s a corner',
          'It decreases linearly, then has a corner, then increases linearly'
        ],
        draw: (ctx, w, h) => {
          ctx.beginPath();
          ctx.moveTo(50, 50);
          ctx.lineTo(w/2, h - 50);
          ctx.lineTo(w - 50, 50);
          ctx.stroke();
          // Corner point
          ctx.fillStyle = '#f59e0b';
          ctx.beginPath();
          ctx.arc(w/2, h - 50, 6, 0, 2 * Math.PI);
          ctx.fill();
        }
      },
      {
        id: 'step-function',
        behaviors: ['constant', 'jump', 'constant', 'jump', 'constant'],
        description: 'A step function with jumps',
        hints: [
          'This function stays flat (constant) in sections',
          'Look for the sudden vertical jumps',
          'Pattern: constant ‚Üí jump ‚Üí constant ‚Üí jump ‚Üí constant'
        ],
        draw: (ctx, w, h) => {
          const levels = [h * 0.7, h * 0.5, h * 0.3];
          const breaks = [w * 0.33, w * 0.67];
          
          ctx.beginPath();
          ctx.moveTo(50, levels[0]);
          ctx.lineTo(breaks[0], levels[0]);
          ctx.stroke();
          
          // Open circle
          ctx.beginPath();
          ctx.arc(breaks[0], levels[0], 4, 0, 2 * Math.PI);
          ctx.fillStyle = 'white';
          ctx.fill();
          ctx.strokeStyle = '#0f766e';
          ctx.stroke();
          
          // Filled circle
          ctx.beginPath();
          ctx.arc(breaks[0], levels[1], 4, 0, 2 * Math.PI);
          ctx.fillStyle = '#0f766e';
          ctx.fill();
          
          ctx.beginPath();
          ctx.moveTo(breaks[0], levels[1]);
          ctx.lineTo(breaks[1], levels[1]);
          ctx.stroke();
          
          // Second jump
          ctx.beginPath();
          ctx.arc(breaks[1], levels[1], 4, 0, 2 * Math.PI);
          ctx.fillStyle = 'white';
          ctx.fill();
          ctx.stroke();
          
          ctx.beginPath();
          ctx.arc(breaks[1], levels[2], 4, 0, 2 * Math.PI);
          ctx.fillStyle = '#0f766e';
          ctx.fill();
          
          ctx.beginPath();
          ctx.moveTo(breaks[1], levels[2]);
          ctx.lineTo(w - 50, levels[2]);
          ctx.stroke();
        }
      }
    ];

    // Build challenges
    const buildChallenges = [
      "A function that increases and is concave up",
      "A function that decreases and is concave down",
      "A function with an inflection point",
      "A V-shaped function with a corner",
      "A function that is constant, then jumps, then increases",
      "An S-curve that's always increasing",
      "A parabola opening downward"
    ];

    // Drawing utilities
    function drawGrid(ctx, w, h) {
      ctx.strokeStyle = '#e0e0e0';
      ctx.lineWidth = 1;
      
      // Grid
      for (let x = 0; x <= w; x += 50) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, h);
        ctx.stroke();
      }
      for (let y = 0; y <= h; y += 50) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(w, y);
        ctx.stroke();
      }
      
      // Axes
      ctx.strokeStyle = '#666';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(0, h/2);
      ctx.lineTo(w, h/2);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(w/2, 0);
      ctx.lineTo(w/2, h);
      ctx.stroke();
    }

    // Demo functions for Introduction
    function showDemo(type) {
      const canvas = document.getElementById('demo-canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
      const w = canvas.width, h = canvas.height;
      
      ctx.clearRect(0, 0, w, h);
      drawGrid(ctx, w, h);
      
      ctx.strokeStyle = '#0f766e';
      ctx.lineWidth = 3;
      
      const padding = 50;
      
      switch(type) {
        case 'increasing':
          ctx.beginPath();
          ctx.moveTo(padding, h - padding);
          ctx.lineTo(w - padding, padding);
          ctx.stroke();
          break;
          
        case 'decreasing':
          ctx.beginPath();
          ctx.moveTo(padding, padding);
          ctx.lineTo(w - padding, h - padding);
          ctx.stroke();
          break;
          
        case 'concave-up':
          ctx.beginPath();
          for (let x = padding; x < w - padding; x += 5) {
            const t = (x - w/2) / (w/3);
            const y = h/2 + 100 * Math.pow(t, 2) - 50;
            if (x === padding) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          }
          ctx.stroke();
          break;
          
        case 'concave-down':
          ctx.beginPath();
          for (let x = padding; x < w - padding; x += 5) {
            const t = (x - w/2) / (w/3);
            const y = h/2 - 100 * Math.pow(t, 2) + 50;
            if (x === padding) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          }
          ctx.stroke();
          break;
          
        case 'inflection':
          ctx.beginPath();
          for (let x = padding; x < w - padding; x += 5) {
            const t = (x - w/2) / (w/3);
            const y = h/2 - 50 * Math.pow(t, 3);
            if (x === padding) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          }
          ctx.stroke();
          ctx.fillStyle = '#f59e0b';
          ctx.beginPath();
          ctx.arc(w/2, h/2, 6, 0, 2 * Math.PI);
          ctx.fill();
          break;
          
        case 'corner':
          ctx.beginPath();
          ctx.moveTo(padding, padding);
          ctx.lineTo(w/2, h - padding);
          ctx.lineTo(w - padding, padding);
          ctx.stroke();
          ctx.fillStyle = '#f59e0b';
          ctx.beginPath();
          ctx.arc(w/2, h - padding, 6, 0, 2 * Math.PI);
          ctx.fill();
          break;
      }
      
      // Update active button
      document.querySelectorAll('.demo-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.toLowerCase().includes(type.replace('-', ' ')));
      });
    }

    // Graph Reading functions
    function generateNewGraph() {
      state.currentGraph = graphProblems[Math.floor(Math.random() * graphProblems.length)];
      state.userDescription = [];
      state.hintLevel = 0;
      
      const canvas = document.getElementById('read-canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
      const w = canvas.width, h = canvas.height;
      
      ctx.clearRect(0, 0, w, h);
      drawGrid(ctx, w, h);
      
      ctx.strokeStyle = '#0f766e';
      ctx.lineWidth = 3;
      
      state.currentGraph.draw(ctx, w, h);
      
      clearDescription();
      document.getElementById('read-feedback').classList.remove('show');
    }

    function addBehavior(behavior) {
      state.userDescription.push(behavior);
      updateDescriptionDisplay();
    }

    function updateDescriptionDisplay() {
      const container = document.getElementById('description-sequence');
      
      if (state.userDescription.length === 0) {
        container.innerHTML = '<div class="placeholder">Add behaviors to describe the function...</div>';
        return;
      }
      
      container.innerHTML = state.userDescription.map((behavior, index) => 
        `<div class="sequence-item" onclick="removeBehavior(${index})">${behavior.replace('-', ' ')}</div>`
      ).join('');
    }

    function removeBehavior(index) {
      state.userDescription.splice(index, 1);
      updateDescriptionDisplay();
    }

    function clearDescription() {
      state.userDescription = [];
      updateDescriptionDisplay();
    }

    function checkDescription() {
      if (!state.currentGraph || state.userDescription.length === 0) {
        const feedback = document.getElementById('read-feedback');
        feedback.className = 'feedback error show';
        feedback.textContent = 'Please add behaviors to describe the function.';
        return;
      }
      
      const correct = JSON.stringify(state.userDescription) === JSON.stringify(state.currentGraph.behaviors);
      const feedback = document.getElementById('read-feedback');
      
      if (correct) {
        feedback.className = 'feedback success show';
        feedback.textContent = '‚úÖ Excellent! You correctly described all behaviors of the function!';
      } else {
        feedback.className = 'feedback error show';
        const diff = state.currentGraph.behaviors.length - state.userDescription.length;
        if (diff > 0) {
          feedback.textContent = `‚ùå You're missing ${diff} behavior(s). Try the hint button for help.`;
        } else if (diff < 0) {
          feedback.textContent = `‚ùå Too many behaviors. You have ${-diff} extra.`;
        } else {
          feedback.textContent = '‚ùå Check the order or specific behaviors. Try the hint button.';
        }
      }
    }

    function getHint() {
      if (!state.currentGraph) return;
      
      const feedback = document.getElementById('read-feedback');
      feedback.className = 'feedback info show';
      
      if (state.hintLevel < state.currentGraph.hints.length) {
        feedback.textContent = `üí° Hint: ${state.currentGraph.hints[state.hintLevel]}`;
        state.hintLevel++;
      } else {
        feedback.textContent = `üìù Answer: ${state.currentGraph.behaviors.map(b => b.replace('-', ' ')).join(' ‚Üí ')}`;
      }
    }

    // Build tab functions
    function drawToolIcons() {
      const tools = [
        { id: 'icon-inc-linear', type: 'inc-linear' },
        { id: 'icon-dec-linear', type: 'dec-linear' },
        { id: 'icon-inc-up', type: 'inc-up' },
        { id: 'icon-inc-down', type: 'inc-down' },
        { id: 'icon-dec-up', type: 'dec-up' },
        { id: 'icon-dec-down', type: 'dec-down' },
        { id: 'icon-constant', type: 'constant' }
      ];
      
      tools.forEach(tool => {
        const canvas = document.getElementById(tool.id);
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        canvas.width = 60;
        canvas.height = 40;
        
        ctx.strokeStyle = '#0f766e';
        ctx.lineWidth = 2;
        ctx.beginPath();
        
        switch(tool.type) {
          case 'inc-linear':
            ctx.moveTo(5, 35);
            ctx.lineTo(55, 5);
            break;
          case 'dec-linear':
            ctx.moveTo(5, 5);
            ctx.lineTo(55, 35);
            break;
          case 'inc-up':
            ctx.moveTo(5, 30);
            ctx.quadraticCurveTo(30, 35, 55, 10);
            break;
          case 'inc-down':
            ctx.moveTo(5, 35);
            ctx.quadraticCurveTo(30, 5, 55, 10);
            break;
          case 'dec-up':
            ctx.moveTo(5, 10);
            ctx.quadraticCurveTo(30, 35, 55, 30);
            break;
          case 'dec-down':
            ctx.moveTo(5, 10);
            ctx.quadraticCurveTo(30, 5, 55, 35);
            break;
          case 'constant':
            ctx.moveTo(5, 20);
            ctx.lineTo(55, 20);
            break;
        }
        ctx.stroke();
      });
    }

    function selectTool(tool) {
      state.selectedTool = tool;
      document.querySelectorAll('.tool-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tool === tool);
      });
    }

    function initBuildCanvas() {
      const canvas = document.getElementById('build-canvas');
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
      
      canvas.addEventListener('click', handleCanvasClick);
      
      redrawBuildCanvas();
    }

    function handleCanvasClick(event) {
      const canvas = document.getElementById('build-canvas');
      const rect = canvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      
      // Add segment starting from last point or this point
      const lastSegment = state.drawnSegments[state.drawnSegments.length - 1];
      const startX = lastSegment ? lastSegment.endX : x;
      const startY = lastSegment ? lastSegment.endY : y;
      
      state.drawnSegments.push({
        type: state.selectedTool,
        startX: startX,
        startY: startY,
        endX: x,
        endY: y
      });
      
      redrawBuildCanvas();
    }

    function redrawBuildCanvas() {
      const canvas = document.getElementById('build-canvas');
      const ctx = canvas.getContext('2d');
      const w = canvas.width, h = canvas.height;
      
      ctx.clearRect(0, 0, w, h);
      drawGrid(ctx, w, h);
      
      ctx.strokeStyle = '#0f766e';
      ctx.lineWidth = 3;
      
      state.drawnSegments.forEach(segment => {
        ctx.beginPath();
        
        switch(segment.type) {
          case 'inc-linear':
          case 'dec-linear':
          case 'constant':
            ctx.moveTo(segment.startX, segment.startY);
            ctx.lineTo(segment.endX, segment.endY);
            break;
            
          case 'inc-up':
          case 'inc-down':
          case 'dec-up':
          case 'dec-down':
            const midX = (segment.startX + segment.endX) / 2;
            let midY;
            
            if (segment.type.includes('up')) {
              midY = Math.max(segment.startY, segment.endY) + 30;
            } else {
              midY = Math.min(segment.startY, segment.endY) - 30;
            }
            
            ctx.moveTo(segment.startX, segment.startY);
            ctx.quadraticCurveTo(midX, midY, segment.endX, segment.endY);
            break;
        }
        
        ctx.stroke();
      });
    }

    function clearCanvas() {
      state.drawnSegments = [];
      state.attemptCount = 0;
      redrawBuildCanvas();
      document.getElementById('build-feedback').classList.remove('show');
    }

    function undoLastSegment() {
      state.drawnSegments.pop();
      redrawBuildCanvas();
    }

    function newChallenge() {
      state.currentChallenge = buildChallenges[Math.floor(Math.random() * buildChallenges.length)];
      document.getElementById('challenge-text').textContent = state.currentChallenge;
      clearCanvas();
    }

    async function checkBuiltFunction() {
      if (state.drawnSegments.length === 0) {
        const feedback = document.getElementById('build-feedback');
        feedback.className = 'feedback error show';
        feedback.textContent = 'Please draw a function first!';
        return;
      }
      
      state.attemptCount++;
      
      // Analyze what the user drew
      const analysis = analyzeDrawnFunction();
      
      const prompt = `You are a calculus teacher checking a student's drawn function.

Challenge: "${state.currentChallenge}"

The student drew segments with these behaviors:
${analysis}

Evaluate if their drawing matches the challenge. Be encouraging but accurate.
${state.attemptCount > 2 ? 'The student has tried ' + state.attemptCount + ' times - give them a specific hint.' : ''}

Respond with brief, specific feedback (2-3 sentences max).`;

      const feedback = document.getElementById('build-feedback');
      
      try {
        const response = await fetch('/api/gemini', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            contents: [{ role: "user", parts: [{ text: prompt }] }] 
          })
        });

        if (!response.ok) throw new Error(`API error: ${response.status}`);
        
        const data = await response.json();
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
        
        if (!text) throw new Error('Empty response from AI');
        
        // Simple check if response indicates success
        const isCorrect = text.toLowerCase().includes('correct') || 
                         text.toLowerCase().includes('good job') || 
                         text.toLowerCase().includes('well done');
        
        feedback.className = `feedback ${isCorrect ? 'success' : 'error'} show`;
        feedback.textContent = text;
        
      } catch (error) {
        console.error('AI evaluation failed:', error);
        feedback.className = 'feedback error show';
        feedback.textContent = 'Could not check with AI. Make sure your function matches: ' + state.currentChallenge;
      }
    }

    function analyzeDrawnFunction() {
      let analysis = [];
      
      state.drawnSegments.forEach((segment, i) => {
        let behavior = '';
        
        // Determine direction
        if (segment.type.includes('inc')) {
          behavior = 'increasing';
        } else if (segment.type.includes('dec')) {
          behavior = 'decreasing';
        } else if (segment.type === 'constant') {
          behavior = 'constant';
        }
        
        // Determine curvature
        if (segment.type.includes('up')) {
          behavior += ' and concave up';
        } else if (segment.type.includes('down')) {
          behavior += ' and concave down';
        } else if (segment.type.includes('linear')) {
          behavior += ' and linear';
        }
        
        analysis.push(`Segment ${i + 1}: ${behavior}`);
      });
      
      return analysis.join('\n');
    }

    // Tab switching
    function switchToTab(tabName) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabName);
      });
      
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === tabName);
      });
      
      if (tabName === 'intro') {
        setTimeout(() => showDemo('increasing'), 100);
      } else if (tabName === 'read') {
        setTimeout(() => generateNewGraph(), 100);
      } else if (tabName === 'build') {
        setTimeout(() => {
          drawToolIcons();
          initBuildCanvas();
          if (!state.currentChallenge) newChallenge();
        }, 100);
      }
    }

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => switchToTab(btn.dataset.tab));
      });
      
      setTimeout(() => showDemo('increasing'), 100);
    });
  </script>
</body>
</html>
