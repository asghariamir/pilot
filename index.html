<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Function Behavior Builder | Mathswell</title>
  <link rel="icon" href="/logo-mathswell-square-mirror.ico" type="image/x-icon">
  <link rel="icon" href="/logo-mathswell-square-mirror.svg" type="image/svg+xml">

  <style>
    :root {
      --primary: #0f766e;
      --primary-light: #10b981;
      --background: #f7faf9;
      --interactive: #e6fffb;
      --text-primary: #212121;
      --text-muted: #4b5563;
      --accent-amber: #f59e0b;
      --accent-red: #c62828;
      --success: #10b981;
      --surface: #ffffff;
      --border: #e0e7e4;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--background);
      color: var(--text-primary);
      line-height: 1.6;
    }
    
    .mathswell-nav {
      display: flex;
      justify-content: center;
      margin: 1rem 0;
      padding: 0.5rem;
    }
    
    .mw-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
      font-weight: 700;
      color: var(--primary);
      padding: 0.5rem 1rem;
      border-radius: 999px;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }
    
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      border-bottom: 2px solid var(--border);
    }
    
    .tab-btn {
      padding: 0.75rem 1.5rem;
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .tab-btn:hover {
      background: var(--interactive);
    }
    
    .tab-btn.active {
      color: var(--primary);
      background: white;
      border-bottom: 2px solid var(--primary);
      margin-bottom: -2px;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .hero {
      background: linear-gradient(135deg, var(--interactive), var(--surface));
      padding: 2rem;
      border-radius: 12px;
      margin-bottom: 2rem;
    }
    
    .hero h1 {
      color: var(--primary);
      margin-bottom: 1rem;
    }
    
    .examples-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .example-card {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }
    
    .example-card h3 {
      color: var(--primary);
      margin-bottom: 1rem;
    }
    
    canvas {
      width: 100%;
      height: 200px;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: white;
      margin-bottom: 1rem;
      display: block;
    }
    
    #main-canvas {
      height: 500px;
      cursor: crosshair;
    }
    
    .math-info {
      background: var(--interactive);
      padding: 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
    }
    
    .math-info strong {
      color: var(--primary);
      display: block;
      margin-bottom: 0.3rem;
    }
    
    .builder-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }
    
    .canvas-wrapper {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }
    
    .controls-wrapper {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
    }
    
    .control-card {
      background: var(--interactive);
      padding: 1rem;
      border-radius: 8px;
    }
    
    .control-card h3 {
      color: var(--primary);
      margin-bottom: 0.75rem;
      font-size: 1rem;
    }
    
    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
      margin-bottom: 0.5rem;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-light);
    }
    
    .btn-secondary {
      background: white;
      color: var(--primary);
      border: 2px solid var(--primary);
    }
    
    .btn-secondary:hover {
      background: var(--interactive);
    }
    
    .btn-danger {
      background: var(--accent-red);
      color: white;
    }
    
    .btn-small {
      padding: 0.3rem 0.6rem;
      font-size: 0.85rem;
      width: auto;
      margin: 0 0.25rem 0.25rem 0;
    }
    
    .point-list {
      max-height: 200px;
      overflow-y: auto;
      font-size: 0.9rem;
    }
    
    .point-item {
      padding: 0.4rem;
      margin-bottom: 0.3rem;
      background: white;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    
    .point-item:hover {
      background: #f0f0f0;
    }
    
    .point-item.selected {
      background: var(--primary);
      color: white;
    }
    
    .segment-list {
      max-height: 200px;
      overflow-y: auto;
    }
    
    .segment-item {
      background: white;
      padding: 0.5rem;
      border-radius: 4px;
      margin-bottom: 0.5rem;
      font-size: 0.85rem;
      border-left: 3px solid var(--primary);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .delete-btn {
      color: var(--accent-red);
      cursor: pointer;
      font-weight: bold;
      padding: 0 0.5rem;
    }
    
    .challenge-section {
      background: linear-gradient(135deg, #fff3cd, #ffeaa7);
      padding: 1.5rem;
      border-radius: 12px;
      border: 2px solid var(--accent-amber);
      margin-top: 1.5rem;
    }
    
    .challenge-section h2 {
      color: #856404;
      margin-bottom: 1rem;
    }
    
    .challenge-box {
      background: white;
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
    }
    
    textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid var(--border);
      border-radius: 6px;
      font-family: inherit;
      font-size: 1rem;
      resize: vertical;
      min-height: 80px;
    }
    
    .feedback {
      padding: 1rem;
      border-radius: 6px;
      margin-top: 1rem;
      display: none;
    }
    
    .feedback.show {
      display: block;
    }
    
    .feedback.success {
      background: #d4edda;
      color: #155724;
    }
    
    .feedback.error {
      background: #f8d7da;
      color: #721c24;
    }
    
    .feedback.info {
      background: #cce5ff;
      color: #004085;
    }
    
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(0,0,0,.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .info-bar {
      background: var(--interactive);
      padding: 0.75rem;
      border-radius: 6px;
      margin-top: 1rem;
      font-size: 0.9rem;
      color: var(--text-muted);
    }
    
    @media (max-width: 768px) {
      .controls-wrapper {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="mathswell-nav">
    <a href="/" class="mw-link">
      <img src="/logo-mathswell-square-mirror.svg" alt="Mathswell" width="28" height="28">
      <span>MATHSWELL</span>
    </a>
  </div>

  <div class="container">
    <div class="tabs">
      <button class="tab-btn active" id="intro-tab">Introduction</button>
      <button class="tab-btn" id="builder-tab">Build & Challenge</button>
    </div>

    <!-- Introduction Tab -->
    <div id="intro-content" class="tab-content active">
      <div class="hero">
        <h1>📈 Function Behavior Builder</h1>
        <p>Learn to analyze and build functions by understanding their behavior: how they increase, decrease, curve, and connect.</p>
      </div>

      <div class="examples-grid">
        <div class="example-card">
          <h3>Increasing & Curving Up</h3>
          <canvas id="ex1"></canvas>
          <div class="math-info">
            <strong>Behavior:</strong>
            • Goes up from left to right<br>
            • Curves upward (like a smile)<br>
            • Gets steeper as x increases<br>
            • Example: Exponential growth
          </div>
        </div>

        <div class="example-card">
          <h3>Decreasing & Curving Down</h3>
          <canvas id="ex2"></canvas>
          <div class="math-info">
            <strong>Behavior:</strong>
            • Goes down from left to right<br>
            • Curves downward (like a frown)<br>
            • Gets less steep over time<br>
            • Example: Cooling curve
          </div>
        </div>

        <div class="example-card">
          <h3>Piecewise with Jump</h3>
          <canvas id="ex3"></canvas>
          <div class="math-info">
            <strong>Behavior:</strong>
            • Has a break (discontinuity)<br>
            • Different rules on each side<br>
            • Open/closed circles matter<br>
            • Example: Step function
          </div>
        </div>

        <div class="example-card">
          <h3>S-Shaped (Inflection)</h3>
          <canvas id="ex4"></canvas>
          <div class="math-info">
            <strong>Behavior:</strong>
            • Changes from curving down to up<br>
            • Has an inflection point<br>
            • Always increasing<br>
            • Example: Logistic growth
          </div>
        </div>

        <div class="example-card">
          <h3>U-Shaped Valley</h3>
          <canvas id="ex5"></canvas>
          <div class="math-info">
            <strong>Behavior:</strong>
            • Decreases then increases<br>
            • Has a minimum point<br>
            • Curves upward throughout<br>
            • Example: Quadratic function
          </div>
        </div>

        <div class="example-card">
          <h3>Approaching a Line</h3>
          <canvas id="ex6"></canvas>
          <div class="math-info">
            <strong>Behavior:</strong>
            • Gets closer to a horizontal line<br>
            • Never quite reaches it<br>
            • Levels off as x increases<br>
            • Example: Decay function
          </div>
        </div>
      </div>

      <div style="text-align: center; margin: 2rem 0;">
        <button class="btn btn-primary" style="width: auto; padding: 1rem 3rem;" id="start-building">
          Start Building Functions →
        </button>
      </div>
    </div>

    <!-- Builder Tab -->
    <div id="builder-content" class="tab-content">
      <div class="builder-container">
        <div class="canvas-wrapper">
          <h2 style="color: var(--primary); margin-bottom: 1rem;">Function Builder</h2>
          <canvas id="main-canvas"></canvas>
          <div class="info-bar">
            <strong>Instructions:</strong> Click to add points • Click points again to toggle open/closed • Select points from the list and create segments
          </div>
        </div>

        <div class="controls-wrapper">
          <div class="control-card">
            <h3>📍 Points</h3>
            <div class="point-list" id="points-list">
              <p style="color: #999;">Click canvas to add points</p>
            </div>
            <button class="btn btn-danger btn-small" id="clear-points">Clear All Points</button>
          </div>

          <div class="control-card">
            <h3>🔧 Build Segments</h3>
            <p style="font-size: 0.85rem; margin-bottom: 0.5rem;">Select points then click:</p>
            <button class="btn btn-secondary btn-small" id="make-line">Make Line (2 points)</button>
            <button class="btn btn-secondary btn-small" id="make-curve">Make Curve (3 points)</button>
            <div style="margin-top: 0.5rem; font-size: 0.85rem;">
              <label><input type="checkbox" id="extend-left"> Extend to left</label><br>
              <label><input type="checkbox" id="extend-right"> Extend to right</label>
            </div>
          </div>

          <div class="control-card">
            <h3>📊 Function Segments</h3>
            <div class="segment-list" id="segments-list">
              <p style="color: #999;">No segments yet</p>
            </div>
            <button class="btn btn-danger btn-small" id="clear-segments">Clear All Segments</button>
          </div>
        </div>

        <div class="challenge-section">
          <h2>🤖 AI Challenge</h2>
          
          <div class="challenge-box">
            <strong>Challenge:</strong>
            <p id="challenge-text">Build a function that increases and curves upward on the left side, has a jump discontinuity in the middle, then decreases and curves downward on the right side.</p>
          </div>
          
          <textarea id="user-response" placeholder="Describe what you built or explain the function's behavior..."></textarea>
          
          <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
            <button class="btn btn-primary" id="check-answer">Check Answer</button>
            <button class="btn btn-secondary" id="get-hint">Get Hint</button>
            <button class="btn btn-secondary" id="new-challenge">New Challenge</button>
          </div>
          
          <div class="feedback" id="feedback"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // State
    let state = {
      points: [],
      selectedPoints: [],
      segments: [],
      currentTab: 'intro',
      challengeIndex: 0
    };

    // Challenges
    const challenges = [
      "Build a function that increases and curves upward on the left side, has a jump discontinuity in the middle, then decreases and curves downward on the right side.",
      "Create a U-shaped function that has its lowest point around x = 0.",
      "Make a function that is constant (flat) on the left, then suddenly jumps up and continues as a straight line going upward.",
      "Build an S-shaped function that starts curving down but changes to curving up.",
      "Create a piecewise function with at least two jumps and three different segments."
    ];

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      setupTabs();
      setupCanvas();
      setupControls();
      setTimeout(() => drawExamples(), 100);
    });

    function setupTabs() {
      document.getElementById('intro-tab').addEventListener('click', () => {
        showTab('intro');
      });
      
      document.getElementById('builder-tab').addEventListener('click', () => {
        showTab('builder');
      });
      
      document.getElementById('start-building').addEventListener('click', () => {
        showTab('builder');
      });
    }

    function showTab(tab) {
      // Update tabs
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      if (tab === 'intro') {
        document.getElementById('intro-tab').classList.add('active');
        document.getElementById('intro-content').classList.add('active');
        setTimeout(() => drawExamples(), 50);
      } else {
        document.getElementById('builder-tab').classList.add('active');
        document.getElementById('builder-content').classList.add('active');
        setTimeout(() => {
          setupCanvas();
          draw();
        }, 50);
      }
      
      state.currentTab = tab;
    }

    function setupCanvas() {
      const canvas = document.getElementById('main-canvas');
      if (!canvas) return;
      
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
      
      // Remove old listener and add new one
      canvas.onclick = null;
      canvas.onclick = function(e) {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        // Check if clicking on existing point
        let clickedPoint = null;
        for (let p of state.points) {
          const px = (p.x + 10) * canvas.width / 20;
          const py = (10 - p.y) * canvas.height / 20;
          if (Math.abs(px - x) < 10 && Math.abs(py - y) < 10) {
            clickedPoint = p;
            break;
          }
        }
        
        if (clickedPoint) {
          // Toggle open/closed
          clickedPoint.open = !clickedPoint.open;
        } else {
          // Add new point
          const graphX = (x / canvas.width) * 20 - 10;
          const graphY = 10 - (y / canvas.height) * 20;
          
          state.points.push({
            x: graphX,
            y: graphY,
            open: false,
            id: Date.now() + Math.random()
          });
        }
        
        updatePointsList();
        draw();
      };
    }

    function setupControls() {
      // Points
      document.getElementById('clear-points').onclick = function() {
        state.points = [];
        state.selectedPoints = [];
        updatePointsList();
        draw();
      };
      
      // Segments
      document.getElementById('make-line').onclick = function() {
        if (state.selectedPoints.length !== 2) {
          alert('Please select exactly 2 points for a line');
          return;
        }
        
        const sorted = [...state.selectedPoints].sort((a, b) => a.x - b.x);
        state.segments.push({
          type: 'line',
          points: sorted.map(p => ({...p})), // Copy points
          extendLeft: document.getElementById('extend-left').checked,
          extendRight: document.getElementById('extend-right').checked,
          id: Date.now()
        });
        
        state.selectedPoints = [];
        updatePointsList();
        updateSegmentsList();
        draw();
      };
      
      document.getElementById('make-curve').onclick = function() {
        if (state.selectedPoints.length !== 3) {
          alert('Please select exactly 3 points for a curve');
          return;
        }
        
        const sorted = [...state.selectedPoints].sort((a, b) => a.x - b.x);
        state.segments.push({
          type: 'curve',
          points: sorted.map(p => ({...p})), // Copy points
          extendLeft: document.getElementById('extend-left').checked,
          extendRight: document.getElementById('extend-right').checked,
          id: Date.now()
        });
        
        state.selectedPoints = [];
        updatePointsList();
        updateSegmentsList();
        draw();
      };
      
      document.getElementById('clear-segments').onclick = function() {
        state.segments = [];
        updateSegmentsList();
        draw();
      };
      
      // Challenge
      document.getElementById('check-answer').onclick = checkAnswer;
      document.getElementById('get-hint').onclick = getHint;
      document.getElementById('new-challenge').onclick = newChallenge;
    }

    function updatePointsList() {
      const list = document.getElementById('points-list');
      if (state.points.length === 0) {
        list.innerHTML = '<p style="color: #999;">Click canvas to add points</p>';
        return;
      }
      
      list.innerHTML = state.points.map(p => {
        const selected = state.selectedPoints.find(sp => sp.id === p.id);
        return `
          <div class="point-item ${selected ? 'selected' : ''}" onclick="toggleSelect(${p.id})">
            <span>(${p.x.toFixed(1)}, ${p.y.toFixed(1)}) ${p.open ? '○' : '●'}</span>
            <span class="delete-btn" onclick="deletePoint(event, ${p.id})">×</span>
          </div>
        `;
      }).join('');
    }

    function updateSegmentsList() {
      const list = document.getElementById('segments-list');
      if (state.segments.length === 0) {
        list.innerHTML = '<p style="color: #999;">No segments yet</p>';
        return;
      }
      
      list.innerHTML = state.segments.map((s, i) => {
        const desc = s.type === 'line' ? 'Line' : 'Curve';
        const ext = (s.extendLeft ? '←' : '') + (s.extendRight ? '→' : '');
        return `
          <div class="segment-item">
            <span>Segment ${i+1}: ${desc} ${ext}</span>
            <span class="delete-btn" onclick="deleteSegment(${s.id})">×</span>
          </div>
        `;
      }).join('');
    }

    window.toggleSelect = function(id) {
      const point = state.points.find(p => p.id === id);
      if (!point) return;
      
      const index = state.selectedPoints.findIndex(p => p.id === id);
      
      if (index >= 0) {
        state.selectedPoints.splice(index, 1);
      } else {
        state.selectedPoints.push(point);
      }
      
      updatePointsList();
      draw();
    };

    window.deletePoint = function(event, id) {
      event.stopPropagation();
      state.points = state.points.filter(p => p.id !== id);
      state.selectedPoints = state.selectedPoints.filter(p => p.id !== id);
      updatePointsList();
      draw();
    };

    window.deleteSegment = function(id) {
      state.segments = state.segments.filter(s => s.id !== id);
      updateSegmentsList();
      draw();
    };

    function draw() {
      const canvas = document.getElementById('main-canvas');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      drawGrid(ctx, canvas);
      drawSegments(ctx, canvas);
      drawPoints(ctx, canvas);
    }

    function drawGrid(ctx, canvas) {
      const w = canvas.width;
      const h = canvas.height;
      
      // Grid
      ctx.strokeStyle = '#e0e0e0';
      ctx.lineWidth = 1;
      
      for (let i = 0; i <= 20; i++) {
        ctx.beginPath();
        ctx.moveTo(i * w / 20, 0);
        ctx.lineTo(i * w / 20, h);
        ctx.stroke();
      }
      
      for (let i = 0; i <= 20; i++) {
        ctx.beginPath();
        ctx.moveTo(0, i * h / 20);
        ctx.lineTo(w, i * h / 20);
        ctx.stroke();
      }
      
      // Axes
      ctx.strokeStyle = '#666';
      ctx.lineWidth = 2;
      
      ctx.beginPath();
      ctx.moveTo(w / 2, 0);
      ctx.lineTo(w / 2, h);
      ctx.stroke();
      
      ctx.beginPath();
      ctx.moveTo(0, h / 2);
      ctx.lineTo(w, h / 2);
      ctx.stroke();
      
      // Labels
      ctx.fillStyle = '#666';
      ctx.font = '11px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      
      for (let i = -10; i <= 10; i += 5) {
        if (i !== 0) {
          ctx.fillText(i, w/2 + i * w/20, h/2 + 5);
        }
      }
    }

    function drawSegments(ctx, canvas) {
      ctx.strokeStyle = '#0f766e';
      ctx.lineWidth = 3;
      
      state.segments.forEach(seg => {
        if (seg.type === 'line') {
          const p1 = seg.points[0];
          const p2 = seg.points[1];
          
          ctx.beginPath();
          
          let x1 = (p1.x + 10) * canvas.width / 20;
          let y1 = (10 - p1.y) * canvas.height / 20;
          let x2 = (p2.x + 10) * canvas.width / 20;
          let y2 = (10 - p2.y) * canvas.height / 20;
          
          if (seg.extendLeft && Math.abs(x2 - x1) > 0.01) {
            const slope = (y2 - y1) / (x2 - x1);
            const yAtLeft = y1 - slope * x1;
            ctx.moveTo(0, yAtLeft);
          } else {
            ctx.moveTo(x1, y1);
          }
          
          if (seg.extendRight && Math.abs(x2 - x1) > 0.01) {
            const slope = (y2 - y1) / (x2 - x1);
            const yAtRight = y2 + slope * (canvas.width - x2);
            ctx.lineTo(canvas.width, yAtRight);
          } else {
            ctx.lineTo(x2, y2);
          }
          
          ctx.stroke();
          
        } else if (seg.type === 'curve') {
          const p1 = seg.points[0];
          const p2 = seg.points[1];
          const p3 = seg.points[2];
          
          const x1 = (p1.x + 10) * canvas.width / 20;
          const y1 = (10 - p1.y) * canvas.height / 20;
          const x2 = (p2.x + 10) * canvas.width / 20;
          const y2 = (10 - p2.y) * canvas.height / 20;
          const x3 = (p3.x + 10) * canvas.width / 20;
          const y3 = (10 - p3.y) * canvas.height / 20;
          
          ctx.beginPath();
          ctx.moveTo(x1, y1);
          ctx.quadraticCurveTo(x2, y2, x3, y3);
          ctx.stroke();
        }
      });
    }

    function drawPoints(ctx, canvas) {
      state.points.forEach(p => {
        const x = (p.x + 10) * canvas.width / 20;
        const y = (10 - p.y) * canvas.height / 20;
        const selected = state.selectedPoints.find(sp => sp.id === p.id);
        
        ctx.strokeStyle = selected ? '#f59e0b' : '#0f766e';
        ctx.fillStyle = p.open ? 'white' : (selected ? '#f59e0b' : '#0f766e');
        ctx.lineWidth = 2;
        
        ctx.beginPath();
        ctx.arc(x, y, 6, 0, 2 * Math.PI);
        ctx.fill();
        ctx.stroke();
      });
    }

    function drawExamples() {
      // Example 1: Increasing & Curving Up
      drawExample('ex1', (ctx, w, h) => {
        ctx.strokeStyle = '#0f766e';
        ctx.lineWidth = 2;
        ctx.beginPath();
        for (let x = -2; x <= 2; x += 0.1) {
          const y = Math.exp(x) - 1;
          const px = (x + 2) * w / 4;
          const py = h - (y + 2) * h / 8;
          if (x === -2) ctx.moveTo(px, py);
          else ctx.lineTo(px, py);
        }
        ctx.stroke();
      });
      
      // Example 2: Decreasing & Curving Down
      drawExample('ex2', (ctx, w, h) => {
        ctx.strokeStyle = '#0f766e';
        ctx.lineWidth = 2;
        ctx.beginPath();
        for (let x = -2; x <= 2; x += 0.1) {
          const y = -Math.sqrt(x + 2);
          const px = (x + 2) * w / 4;
          const py = h/2 - y * h / 4;
          if (x === -2) ctx.moveTo(px, py);
          else ctx.lineTo(px, py);
        }
        ctx.stroke();
      });
      
      // Example 3: Piecewise with Jump
      drawExample('ex3', (ctx, w, h) => {
        ctx.strokeStyle = '#0f766e';
        ctx.lineWidth = 2;
        
        // Left piece
        ctx.beginPath();
        ctx.moveTo(w * 0.1, h * 0.6);
        ctx.lineTo(w * 0.45, h * 0.4);
        ctx.stroke();
        
        // Open circle
        ctx.beginPath();
        ctx.arc(w * 0.45, h * 0.4, 4, 0, 2 * Math.PI);
        ctx.fillStyle = 'white';
        ctx.fill();
        ctx.stroke();
        
        // Closed circle
        ctx.beginPath();
        ctx.arc(w * 0.55, h * 0.7, 4, 0, 2 * Math.PI);
        ctx.fillStyle = '#0f766e';
        ctx.fill();
        
        // Right piece
        ctx.beginPath();
        ctx.moveTo(w * 0.55, h * 0.7);
        ctx.lineTo(w * 0.9, h * 0.5);
        ctx.stroke();
      });
      
      // Example 4: S-Shaped
      drawExample('ex4', (ctx, w, h) => {
        ctx.strokeStyle = '#0f766e';
        ctx.lineWidth = 2;
        ctx.beginPath();
        for (let x = -2; x <= 2; x += 0.1) {
          const y = x * x * x;
          const px = (x + 2) * w / 4;
          const py = h/2 - y * h / 16;
          if (x === -2) ctx.moveTo(px, py);
          else ctx.lineTo(px, py);
        }
        ctx.stroke();
      });
      
      // Example 5: U-Shaped
      drawExample('ex5', (ctx, w, h) => {
        ctx.strokeStyle = '#0f766e';
        ctx.lineWidth = 2;
        ctx.beginPath();
        for (let x = -2; x <= 2; x += 0.1) {
          const y = x * x;
          const px = (x + 2) * w / 4;
          const py = h - (y + 1) * h / 6;
          if (x === -2) ctx.moveTo(px, py);
          else ctx.lineTo(px, py);
        }
        ctx.stroke();
      });
      
      // Example 6: Approaching Line
      drawExample('ex6', (ctx, w, h) => {
        ctx.strokeStyle = '#0f766e';
        ctx.lineWidth = 2;
        ctx.beginPath();
        for (let x = 0; x <= 4; x += 0.1) {
          const y = 2 - 2 * Math.exp(-x);
          const px = x * w / 4;
          const py = h - y * h / 3;
          if (x === 0) ctx.moveTo(px, py);
          else ctx.lineTo(px, py);
        }
        ctx.stroke();
        
        // Asymptote
        ctx.strokeStyle = '#f59e0b';
        ctx.setLineDash([5, 5]);
        ctx.beginPath();
        ctx.moveTo(0, h/3);
        ctx.lineTo(w, h/3);
        ctx.stroke();
        ctx.setLineDash([]);
      });
    }

    function drawExample(id, drawFunc) {
      const canvas = document.getElementById(id);
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
      
      // Clear
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Grid
      ctx.strokeStyle = '#f0f0f0';
      ctx.lineWidth = 1;
      
      for (let i = 0; i <= 4; i++) {
        ctx.beginPath();
        ctx.moveTo(i * canvas.width / 4, 0);
        ctx.lineTo(i * canvas.width / 4, canvas.height);
        ctx.stroke();
        
        ctx.beginPath();
        ctx.moveTo(0, i * canvas.height / 4);
        ctx.lineTo(canvas.width, i * canvas.height / 4);
        ctx.stroke();
      }
      
      // Axes
      ctx.strokeStyle = '#ddd';
      ctx.lineWidth = 1.5;
      ctx.beginPath();
      ctx.moveTo(canvas.width / 2, 0);
      ctx.lineTo(canvas.width / 2, canvas.height);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(0, canvas.height / 2);
      ctx.lineTo(canvas.width, canvas.height / 2);
      ctx.stroke();
      
      // Draw the function
      drawFunc(ctx, canvas.width, canvas.height);
    }

    function newChallenge() {
      state.challengeIndex = (state.challengeIndex + 1) % challenges.length;
      document.getElementById('challenge-text').textContent = challenges[state.challengeIndex];
      document.getElementById('feedback').classList.remove('show');
      document.getElementById('user-response').value = '';
    }

    async function checkAnswer() {
      const response = document.getElementById('user-response').value;
      const feedback = document.getElementById('feedback');
      
      if (!response.trim()) {
        feedback.className = 'feedback show error';
        feedback.innerHTML = 'Please describe your function first!';
        return;
      }
      
      if (state.segments.length === 0) {
        feedback.className = 'feedback show error';
        feedback.innerHTML = 'Build a function first, then describe it!';
        return;
      }
      
      feedback.className = 'feedback show info';
      feedback.innerHTML = '<span class="loading"></span> Checking...';
      
      try {
        const prompt = `Student built a function with ${state.segments.length} segments for: "${challenges[state.challengeIndex]}". Their description: "${response}". Give brief encouraging feedback (2 sentences max).`;
        
        const apiResponse = await fetch('/api/gemini', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            contents: [{ role: "user", parts: [{ text: prompt }] }] 
          })
        });
        
        if (!apiResponse.ok) throw new Error('API error');
        
        const data = await apiResponse.json();
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text || 'Good work! Keep exploring!';
        
        feedback.className = 'feedback show success';
        feedback.innerHTML = text;
      } catch (error) {
        feedback.className = 'feedback show success';
        feedback.innerHTML = 'Good work! Your function shows understanding of the key concepts. Try the next challenge!';
      }
    }

    async function getHint() {
      const feedback = document.getElementById('feedback');
      
      feedback.className = 'feedback show info';
      feedback.innerHTML = '<span class="loading"></span> Getting hint...';
      
      try {
        const prompt = `Give a simple hint for: "${challenges[state.challengeIndex]}". Focus on the behavior, not formulas. One sentence only.`;
        
        const apiResponse = await fetch('/api/gemini', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            contents: [{ role: "user", parts: [{ text: prompt }] }] 
          })
        });
        
        if (!apiResponse.ok) throw new Error('API error');
        
        const data = await apiResponse.json();
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text || 'Think about how the function changes direction and shape.';
        
        feedback.className = 'feedback show info';
        feedback.innerHTML = '💡 ' + text;
      } catch (error) {
        feedback.className = 'feedback show info';
        feedback.innerHTML = '💡 Think about how the function changes direction and where it curves!';
      }
    }

    // Handle resize
    window.addEventListener('resize', () => {
      if (state.currentTab === 'intro') {
        drawExamples();
      } else {
        setupCanvas();
        draw();
      }
    });
  </script>
</body>
</html>
