<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Function Behavior Cards | Mathswell</title>
  <link rel="icon" href="/logo-mathswell-square-mirror.ico" type="image/x-icon">
  <link rel="icon" href="/logo-mathswell-square-mirror.svg" type="image/svg+xml">
  <style>
    :root {
      --primary: #0f766e;
      --primary-light: #10b981;
      --primary-dark: #0a5a52;
      --background: #f7faf9;
      --interactive: #e6fffb;
      --text-primary: #212121;
      --text-muted: #4b5563;
      --accent-amber: #f59e0b;
      --accent-red: #dc2626;
      --accent-blue: #2563eb;
      --surface: #ffffff;
      --border: #e0e7e4;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #dc2626;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, var(--background) 0%, #f0f9f8 100%);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }

    .mathswell-nav {
      display: flex;
      justify-content: center;
      margin: 1.5rem 0;
      padding: 0.5rem;
    }

    .mw-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
      font-weight: 700;
      color: var(--primary);
      padding: 0.5rem 1rem;
      border-radius: 999px;
      background: #fff;
      box-shadow: 0 2px 8px rgba(15, 118, 110, 0.1);
      transition: all 0.3s ease;
    }

    .mw-link:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(15, 118, 110, 0.2);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      background: white;
      border-radius: 12px;
      padding: 0.5rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      justify-content: center;
    }

    .tab-btn {
      padding: 0.75rem 1.5rem;
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 8px;
      flex: 1;
      max-width: 200px;
    }

    .tab-btn:hover {
      background: var(--interactive);
      color: var(--primary);
    }

    .tab-btn.active {
      color: white;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      box-shadow: 0 2px 8px rgba(15, 118, 110, 0.15);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .hero {
      background: linear-gradient(135deg, #fff, var(--interactive));
      padding: 2.5rem;
      border-radius: 16px;
      margin-bottom: 2rem;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      text-align: center;
    }

    .hero h1 {
      color: var(--primary);
      margin-bottom: 1rem;
      font-size: 2.2rem;
      font-weight: 700;
    }

    .hero p {
      color: var(--text-muted);
      font-size: 1.1rem;
      max-width: 700px;
      margin: 0 auto;
    }

    .examples-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .example-card {
      background: #fff;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      border: 1px solid var(--border);
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
    }

    .example-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      border-color: var(--primary-light);
    }

    .example-card h3 {
      color: var(--primary);
      margin-bottom: 1rem;
      font-size: 1.1rem;
      text-align: center;
    }

    .example-canvas {
      width: 100%;
      height: 120px;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: #fff;
      margin-bottom: 0.5rem;
      display: block;
    }

    .example-info {
      position: absolute;
      bottom: 10px;
      left: 10px;
      right: 10px;
      background: var(--interactive);
      padding: 0.5rem;
      border-radius: 6px;
      font-size: 0.85rem;
      text-align: center;
      display: none;
    }

    .example-card.show-math .example-info.math,
    .example-card.show-interval .example-info.interval {
      display: block;
    }

    /* Card system styles */
    .card-bank {
      background: linear-gradient(135deg, var(--interactive), #f8fffe);
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    }

    .card-bank h3 {
      color: var(--primary);
      margin-bottom: 1rem;
      font-size: 1.2rem;
      text-align: center;
    }

    .cards-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      min-height: 80px;
      justify-content: center;
    }

    /* Word cards for Tab 2 */
    .word-card {
      padding: 0.75rem 1.25rem;
      background: white;
      border: 2px solid var(--primary);
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
      font-weight: 600;
      color: var(--primary);
    }

    .word-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(15, 118, 110, 0.2);
      background: var(--interactive);
    }

    .word-card.selected {
      background: var(--primary);
      color: white;
    }

    .word-card.dragging {
      opacity: 0.5;
    }

    /* Tab 3 specific styles - IMPROVED */
    .interval-selector {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    }

    .interval-selector h3 {
      color: var(--primary);
      margin-bottom: 1.5rem;
      text-align: center;
      font-size: 1.3rem;
    }

    .interval-builder {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      justify-content: center;
      margin-bottom: 1.5rem;
      padding: 1.5rem;
      background: linear-gradient(135deg, var(--interactive), #f0fffc);
      border-radius: 12px;
      border: 2px solid var(--primary-light);
    }

    .bracket-toggle {
      width: 45px;
      height: 50px;
      font-size: 1.6rem;
      border: 2px solid var(--primary);
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      border-radius: 6px;
      font-weight: 500;
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .bracket-toggle.closed {
      background: var(--primary);
      color: white;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(15, 118, 110, 0.3);
    }

    .bracket-toggle:hover {
      transform: scale(1.08);
      box-shadow: 0 2px 8px rgba(15, 118, 110, 0.2);
    }

    .interval-input {
      width: 80px;
      padding: 0.75rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      text-align: center;
      font-size: 1.1rem;
      font-weight: 600;
      transition: all 0.2s;
      background: white;
    }

    .interval-input:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.1);
    }

    .interval-input:placeholder-shown {
      font-style: italic;
      font-weight: normal;
    }

    .infinity-toggle {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      user-select: none;
      padding: 0.5rem;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .infinity-toggle:hover {
      background: var(--interactive);
    }

    .infinity-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .infinity-label {
      font-size: 1.1rem;
      color: var(--primary);
      font-weight: 600;
    }

    .comma {
      font-size: 1.4rem;
      color: var(--text-muted);
      font-weight: 600;
    }

    .add-interval-btn {
      padding: 0.75rem 2rem;
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(15, 118, 110, 0.2);
    }

    .add-interval-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(15, 118, 110, 0.3);
    }

    .add-interval-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .preset-intervals {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      justify-content: center;
      padding-top: 1.5rem;
      border-top: 2px dashed var(--border);
    }

    .preset-label {
      width: 100%;
      text-align: center;
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }

    .preset-btn {
      padding: 0.5rem 1rem;
      background: white;
      border: 2px solid var(--primary);
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
      color: var(--primary);
      font-weight: 600;
    }

    .preset-btn:hover {
      background: var(--interactive);
      transform: translateY(-2px);
      box-shadow: 0 2px 4px rgba(15, 118, 110, 0.2);
    }

    .point-input-group {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      justify-content: center;
      padding: 1rem;
      background: var(--interactive);
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .point-label {
      font-size: 1.2rem;
      color: var(--primary);
      font-weight: 600;
    }

    .workspace {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      min-height: 150px;
    }

    .workspace h3 {
      color: var(--primary);
      margin-bottom: 1rem;
      text-align: center;
    }

    .interval-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .interval-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: var(--interactive);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .interval-item:hover {
      transform: translateX(5px);
    }

    .interval-item.selected {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.1);
    }

    .interval-item .interval-text {
      font-weight: 600;
      color: var(--primary);
      min-width: 100px;
      font-size: 1.05rem;
    }

    .interval-item canvas {
      flex: 1;
      height: 40px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: white;
    }

    .interval-item .remove-btn {
      padding: 0.25rem 0.5rem;
      background: var(--error);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .control-cards {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    }

    .control-cards h3 {
      color: var(--primary);
      margin-bottom: 1rem;
      text-align: center;
    }

    .control-group {
      margin-bottom: 1rem;
    }

    .control-group-label {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }

    .control-row {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    .control-card {
      width: 70px;
      height: 60px;
      background: white;
      border: 2px solid var(--primary);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .control-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(15, 118, 110, 0.2);
    }

    .control-card.active {
      background: var(--primary);
      border-color: var(--primary-dark);
    }

    .control-card.active::after {
      content: '✓';
      position: absolute;
      top: 2px;
      right: 4px;
      color: white;
      font-size: 0.8rem;
      font-weight: bold;
    }

    .control-card canvas {
      width: 90%;
      height: 80%;
      pointer-events: none;
    }

    .sequence-area {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      margin-bottom: 2rem;
      min-height: 200px;
    }

    .sequence-area h3 {
      color: var(--primary);
      margin-bottom: 1rem;
      text-align: center;
    }

    .sequence-container {
      display: flex;
      gap: 0.75rem;
      padding: 1.5rem;
      background: var(--interactive);
      border-radius: 8px;
      min-height: 100px;
      align-items: center;
      flex-wrap: wrap;
      border: 2px dashed var(--primary);
      justify-content: center;
    }

    .sequence-container.drag-over {
      background: #d1f4f0;
      border-color: var(--primary-light);
    }

    .graph-display {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      margin-bottom: 2rem;
    }

    .graph-display h3 {
      color: var(--primary);
      margin-bottom: 1rem;
      text-align: center;
    }

    .graph-canvas {
      width: 100%;
      height: 350px;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: white;
      display: block;
    }

    .controls {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.95rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(15, 118, 110, 0.3);
    }

    .btn-secondary {
      background: white;
      color: var(--primary);
      border: 2px solid var(--primary);
    }

    .btn-secondary:hover {
      background: var(--interactive);
    }

    .feedback {
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
      display: none;
      border-left: 4px solid;
      text-align: center;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .feedback.show {
      display: block;
    }

    .feedback.success {
      background: #d4edda;
      color: #155724;
      border-left-color: var(--success);
    }

    .feedback.error {
      background: #f8d7da;
      color: #721c24;
      border-left-color: var(--error);
    }

    .feedback.info {
      background: #cce5ff;
      color: #004085;
      border-left-color: var(--accent-blue);
    }

    .sentence-display {
      background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      padding: 1.5rem;
      border-radius: 8px;
      margin-top: 1rem;
      font-size: 1.1rem;
      text-align: center;
      color: var(--primary-dark);
      animation: celebrate 0.5s ease;
    }

    @keyframes celebrate {
      0% { transform: scale(0.95); opacity: 0; }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); opacity: 1; }
    }

    .challenge-box {
      background: linear-gradient(135deg, #fffbeb, #fef3c7);
      padding: 1.5rem;
      border-radius: 12px;
      border: 2px solid var(--accent-amber);
      margin-bottom: 2rem;
      text-align: center;
    }

    .challenge-box h4 {
      color: #92400e;
      margin-bottom: 0.5rem;
      font-size: 1.3rem;
    }

    .challenge-text {
      color: #451a03;
      font-size: 1.2rem;
      font-weight: 600;
    }

    .placeholder-text {
      color: var(--text-muted);
      font-style: italic;
      text-align: center;
      padding: 2rem;
    }

    .ai-disclaimer {
      text-align: center;
      color: var(--text-muted);
      font-size: 0.8rem;
      font-style: italic;
      margin-top: 1rem;
      opacity: 0.7;
    }

    .cta-buttons {
      text-align: center;
      margin-top: 2rem;
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    @media (max-width: 768px) {
      .tabs {
        flex-direction: column;
      }
      
      .tab-btn {
        max-width: 100%;
      }
      
      .word-card {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
      }
      
      .control-card {
        width: 60px;
        height: 50px;
      }
      
      .interval-builder {
        flex-direction: column;
        gap: 1rem;
      }
      
      .bracket-toggle {
        width: 40px;
        height: 45px;
      }
    }
  </style>
</head>
<body>
  <div class="mathswell-nav">
    <a href="/" class="mw-link">
      <img src="/logo-mathswell-square-mirror.svg" alt="Mathswell" width="28" height="28">
      <span>MATHSWELL</span>
    </a>
  </div>

  <div class="container">
    <div class="tabs">
      <button class="tab-btn active" data-tab="intro">Introduction</button>
      <button class="tab-btn" data-tab="read">Read the Graph</button>
      <button class="tab-btn" data-tab="build">Build from Behavior</button>
    </div>

    <!-- INTRODUCTION TAB -->
    <div id="intro" class="tab-content active">
      <div class="hero">
        <h1>Function Behavior Cards</h1>
        <p>Master function analysis by recognizing behaviors visually and describing them mathematically. Click examples to see notation.</p>
      </div>

      <div class="examples-grid">
        <div class="example-card" onclick="toggleExampleInfo(this)">
          <h3>Increasing</h3>
          <canvas class="example-canvas" id="ex-inc"></canvas>
          <div class="example-info math">f'(x) > 0</div>
          <div class="example-info interval">on (a, b)</div>
        </div>
        <div class="example-card" onclick="toggleExampleInfo(this)">
          <h3>Decreasing</h3>
          <canvas class="example-canvas" id="ex-dec"></canvas>
          <div class="example-info math">f'(x) < 0</div>
          <div class="example-info interval">on (a, b)</div>
        </div>
        <div class="example-card" onclick="toggleExampleInfo(this)">
          <h3>Concave Up</h3>
          <canvas class="example-canvas" id="ex-cup"></canvas>
          <div class="example-info math">f''(x) > 0</div>
          <div class="example-info interval">on (a, b)</div>
        </div>
        <div class="example-card" onclick="toggleExampleInfo(this)">
          <h3>Concave Down</h3>
          <canvas class="example-canvas" id="ex-cdown"></canvas>
          <div class="example-info math">f''(x) < 0</div>
          <div class="example-info interval">on (a, b)</div>
        </div>
        <div class="example-card" onclick="toggleExampleInfo(this)">
          <h3>Jump Discontinuity</h3>
          <canvas class="example-canvas" id="ex-jump"></canvas>
          <div class="example-info math">lim x→c⁻ ≠ lim x→c⁺</div>
          <div class="example-info interval">at x = c</div>
        </div>
        <div class="example-card" onclick="toggleExampleInfo(this)">
          <h3>Inflection Point</h3>
          <canvas class="example-canvas" id="ex-inflect"></canvas>
          <div class="example-info math">f''(x) changes sign</div>
          <div class="example-info interval">at x = c</div>
        </div>
        <div class="example-card" onclick="toggleExampleInfo(this)">
          <h3>Vertical Asymptote</h3>
          <canvas class="example-canvas" id="ex-vert"></canvas>
          <div class="example-info math">lim x→c f(x) = ±∞</div>
          <div class="example-info interval">at x = c</div>
        </div>
        <div class="example-card" onclick="toggleExampleInfo(this)">
          <h3>Horizontal Asymptote</h3>
          <canvas class="example-canvas" id="ex-horiz"></canvas>
          <div class="example-info math">lim x→±∞ f(x) = L</div>
          <div class="example-info interval">y = L</div>
        </div>
      </div>

      <div class="cta-buttons">
        <button class="btn btn-primary" onclick="switchToTab('read')">Try Reading Graphs →</button>
        <button class="btn btn-primary" onclick="switchToTab('build')">Build Functions →</button>
      </div>
    </div>

    <!-- READ THE GRAPH TAB -->
    <div id="read" class="tab-content">
      <div class="graph-display">
        <h3>Analyze This Function</h3>
        <canvas class="graph-canvas" id="read-graph"></canvas>
        <div class="controls">
          <button class="btn btn-secondary" onclick="generateNewReadProblem()">New Function</button>
        </div>
      </div>

      <div class="card-bank">
        <h3>Behavior Word Cards</h3>
        <p style="text-align: center; color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">
          Click to select/unselect, or drag to sequence
        </p>
        <div class="cards-container" id="read-cards">
          <!-- Word cards will be generated here -->
        </div>
      </div>

      <div class="sequence-area">
        <h3>Your Description</h3>
        <div class="sequence-container" id="read-sequence">
          <div class="placeholder-text">Drag word cards here or click selected cards to remove</div>
        </div>
        <div class="controls">
          <button class="btn btn-primary" onclick="checkReadAnswer()">Check Answer</button>
          <button class="btn btn-secondary" onclick="clearReadSequence()">Clear</button>
          <button class="btn btn-secondary" onclick="getHint()">Hint</button>
        </div>
        <div class="feedback" id="read-feedback"></div>
        <div id="sentence-display"></div>
      </div>
    </div>

    <!-- BUILD FROM BEHAVIOR TAB -->
    <div id="build" class="tab-content">
      <div class="challenge-box">
        <h4>Build This Function:</h4>
        <div class="challenge-text" id="build-challenge">
          A function that is increasing and concave up
        </div>
        <div class="controls">
          <button class="btn btn-secondary" onclick="generateNewBuildChallenge()">New Challenge</button>
        </div>
      </div>

      <div class="interval-selector">
        <h3>Step 1: Define Intervals</h3>
        
        <!-- Custom Interval Builder -->
        <div class="interval-builder">
          <button class="bracket-toggle" id="left-bracket" onclick="toggleBracket('left')">(</button>
          
          <div class="infinity-toggle">
            <input type="checkbox" id="left-infinity" class="infinity-checkbox" onchange="toggleInfinity('left')">
            <label for="left-infinity" class="infinity-label">-∞</label>
          </div>
          
          <input type="text" id="left-value" class="interval-input" placeholder="-2" value="-2">
          
          <span class="comma">,</span>
          
          <input type="text" id="right-value" class="interval-input" placeholder="2" value="2">
          
          <div class="infinity-toggle">
            <input type="checkbox" id="right-infinity" class="infinity-checkbox" onchange="toggleInfinity('right')">
            <label for="right-infinity" class="infinity-label">+∞</label>
          </div>
          
          <button class="bracket-toggle" id="right-bracket" onclick="toggleBracket('right')">)</button>
          
          <button class="add-interval-btn" onclick="addCustomInterval()">Add Interval</button>
        </div>
        
        <!-- Point Input -->
        <div class="point-input-group">
          <span class="point-label">x =</span>
          <input type="text" id="point-value" class="interval-input" placeholder="0" value="0">
          <button class="add-interval-btn" onclick="addPoint()">Add Point</button>
        </div>
        
        <!-- Preset Intervals -->
        <div class="preset-intervals">
          <div class="preset-label">Quick Presets:</div>
          <button class="preset-btn" onclick="setPresetInterval('ninf-0')">(-∞, 0)</button>
          <button class="preset-btn" onclick="setPresetInterval('0-inf')">(0, ∞)</button>
          <button class="preset-btn" onclick="setPresetInterval('full')">(-∞, ∞)</button>
          <button class="preset-btn" onclick="setPresetInterval('-1-1')">[-1, 1]</button>
          <button class="preset-btn" onclick="setPresetInterval('point-0')">x = 0</button>
        </div>
      </div>

      <div class="workspace">
        <h3>Step 2: Your Function Intervals</h3>
        <div class="interval-list" id="interval-list">
          <div class="placeholder-text">Use the interval builder above to add segments</div>
        </div>
      </div>

      <div class="control-cards">
        <h3>Step 3: Control Behaviors (click interval first)</h3>
        
        <div class="control-group">
          <div class="control-group-label">Direction</div>
          <div class="control-row">
            <div class="control-card" data-behavior="increasing" onclick="toggleBehavior(this)">
              <canvas id="ctrl-inc"></canvas>
            </div>
            <div class="control-card" data-behavior="decreasing" onclick="toggleBehavior(this)">
              <canvas id="ctrl-dec"></canvas>
            </div>
            <div class="control-card" data-behavior="constant" onclick="toggleBehavior(this)">
              <canvas id="ctrl-const"></canvas>
            </div>
          </div>
        </div>

        <div class="control-group">
          <div class="control-group-label">Curvature</div>
          <div class="control-row">
            <div class="control-card" data-behavior="concave-up" onclick="toggleBehavior(this)">
              <canvas id="ctrl-cup"></canvas>
            </div>
            <div class="control-card" data-behavior="concave-down" onclick="toggleBehavior(this)">
              <canvas id="ctrl-cdown"></canvas>
            </div>
            <div class="control-card" data-behavior="linear" onclick="toggleBehavior(this)">
              <canvas id="ctrl-linear"></canvas>
            </div>
          </div>
        </div>

        <div class="control-group">
          <div class="control-group-label">Special Features</div>
          <div class="control-row">
            <div class="control-card" data-behavior="inflection" onclick="toggleBehavior(this)">
              <canvas id="ctrl-inflection"></canvas>
            </div>
            <div class="control-card" data-behavior="jump-up" onclick="toggleBehavior(this)">
              <canvas id="ctrl-jump-up"></canvas>
            </div>
            <div class="control-card" data-behavior="jump-down" onclick="toggleBehavior(this)">
              <canvas id="ctrl-jump-down"></canvas>
            </div>
            <div class="control-card" data-behavior="v-asymptote" onclick="toggleBehavior(this)">
              <canvas id="ctrl-vasym"></canvas>
            </div>
            <div class="control-card" data-behavior="h-asymptote" onclick="toggleBehavior(this)">
              <canvas id="ctrl-hasym"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="graph-display">
        <h3>Your Function Preview</h3>
        <canvas class="graph-canvas" id="build-graph"></canvas>
        <div class="controls">
          <button class="btn btn-primary" onclick="checkBuildAnswer()">Check with AI</button>
          <button class="btn btn-secondary" onclick="clearBuildWorkspace()">Clear All</button>
        </div>
        <div class="feedback" id="build-feedback"></div>
      </div>

      <p class="ai-disclaimer">
        AI assistance may occasionally be unavailable during high traffic periods.
      </p>
    </div>
  </div>

  <script>
    // Global state
    const state = {
      readProblem: null,
      readSequence: [],
      buildChallenge: null,
      buildIntervals: [],
      selectedInterval: null,
      draggedCard: null,
      hintCount: 0,
      exampleClickCount: {},
      intervalBuilder: {
        leftBracket: 'open',
        rightBracket: 'open',
        leftInfinity: false,
        rightInfinity: false
      }
    };

    // Word behavior types for Read tab
    const behaviorTypes = [
      { id: 'increasing', label: 'Increasing' },
      { id: 'decreasing', label: 'Decreasing' },
      { id: 'constant', label: 'Constant' },
      { id: 'concave-up', label: 'Concave Up' },
      { id: 'concave-down', label: 'Concave Down' },
      { id: 'linear', label: 'Linear' },
      { id: 'inflection', label: 'Inflection Point' },
      { id: 'jump-up', label: 'Jump Up' },
      { id: 'jump-down', label: 'Jump Down' },
      { id: 'vertical-asymptote', label: 'Vertical Asymptote' },
      { id: 'horizontal-asymptote', label: 'Horizontal Asymptote' }
    ];

    // Drawing functions for examples and controls
    function drawIncreasing(ctx, w, h) {
      ctx.strokeStyle = '#0f766e';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(10, h - 10);
      ctx.lineTo(w - 10, 10);
      ctx.stroke();
    }

    function drawDecreasing(ctx, w, h) {
      ctx.strokeStyle = '#0f766e';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(10, 10);
      ctx.lineTo(w - 10, h - 10);
      ctx.stroke();
    }

    function drawConstant(ctx, w, h) {
      ctx.strokeStyle = '#0f766e';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(10, h/2);
      ctx.lineTo(w - 10, h/2);
      ctx.stroke();
    }

    function drawLinear(ctx, w, h) {
      ctx.strokeStyle = '#0f766e';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(10, h * 0.6);
      ctx.lineTo(w - 10, h * 0.4);
      ctx.stroke();
    }

    function drawConcaveUp(ctx, w, h) {
      ctx.strokeStyle = '#0f766e';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(10, h - 10);
      ctx.quadraticCurveTo(w/2, h - 5, w - 10, 10);
      ctx.stroke();
    }

    function drawConcaveDown(ctx, w, h) {
      ctx.strokeStyle = '#0f766e';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(10, 10);
      ctx.quadraticCurveTo(w/2, 5, w - 10, h - 10);
      ctx.stroke();
    }

    function drawInflection(ctx, w, h) {
      ctx.strokeStyle = '#0f766e';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(10, h - 10);
      ctx.bezierCurveTo(w/3, h - 10, w*2/3, 10, w - 10, 10);
      ctx.stroke();
      ctx.fillStyle = '#f59e0b';
      ctx.beginPath();
      ctx.arc(w/2, h/2, 4, 0, 2 * Math.PI);
      ctx.fill();
    }

    function drawJumpUp(ctx, w, h) {
      ctx.strokeStyle = '#0f766e';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(10, h * 0.7);
      ctx.lineTo(w/2 - 5, h * 0.7);
      ctx.stroke();
      ctx.beginPath();
      ctx.arc(w/2 - 5, h * 0.7, 4, 0, 2 * Math.PI);
      ctx.fillStyle = 'white';
      ctx.fill();
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(w/2 + 5, h * 0.3);
      ctx.lineTo(w - 10, h * 0.3);
      ctx.stroke();
      ctx.beginPath();
      ctx.arc(w/2 + 5, h * 0.3, 4, 0, 2 * Math.PI);
      ctx.fillStyle = '#0f766e';
      ctx.fill();
    }

    function drawJumpDown(ctx, w, h) {
      ctx.strokeStyle = '#0f766e';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(10, h * 0.3);
      ctx.lineTo(w/2 - 5, h * 0.3);
      ctx.stroke();
      ctx.beginPath();
      ctx.arc(w/2 - 5, h * 0.3, 4, 0, 2 * Math.PI);
      ctx.fillStyle = '#0f766e';
      ctx.fill();
      ctx.beginPath();
      ctx.moveTo(w/2 + 5, h * 0.7);
      ctx.lineTo(w - 10, h * 0.7);
      ctx.stroke();
      ctx.beginPath();
      ctx.arc(w/2 + 5, h * 0.7, 4, 0, 2 * Math.PI);
      ctx.fillStyle = 'white';
      ctx.fill();
      ctx.stroke();
    }

    function drawVerticalAsymptote(ctx, w, h) {
      ctx.strokeStyle = '#dc2626';
      ctx.lineWidth = 3;
      ctx.setLineDash([6, 4]);
      ctx.beginPath();
      ctx.moveTo(w * 0.7, 5);
      ctx.lineTo(w * 0.7, h - 5);
      ctx.stroke();
      ctx.setLineDash([]);
      ctx.strokeStyle = '#0f766e';
      ctx.beginPath();
      ctx.moveTo(10, h/2);
      for (let x = 10; x < w * 0.7 - 8; x += 3) {
        const t = (x - 10) / (w * 0.7 - 18);
        const y = h/2 - h * 0.4 * Math.pow(t, 2);
        ctx.lineTo(x, Math.max(5, y));
      }
      ctx.stroke();
    }

    function drawHorizontalAsymptote(ctx, w, h) {
      ctx.strokeStyle = '#dc2626';
      ctx.lineWidth = 3;
      ctx.setLineDash([6, 4]);
      ctx.beginPath();
      ctx.moveTo(5, h * 0.3);
      ctx.lineTo(w - 5, h * 0.3);
      ctx.stroke();
      ctx.setLineDash([]);
      ctx.strokeStyle = '#0f766e';
      ctx.beginPath();
      ctx.moveTo(10, h * 0.8);
      for (let x = 10; x < w - 10; x += 3) {
        const t = (x - 10) / (w - 20);
        const y = h * 0.8 - (h * 0.8 - h * 0.3 - 5) * (1 - Math.exp(-3*t));
        ctx.lineTo(x, y);
      }
      ctx.stroke();
    }

    // Toggle example info in Tab 1
    function toggleExampleInfo(card) {
      const id = card.querySelector('.example-canvas').id;
      if (!state.exampleClickCount[id]) state.exampleClickCount[id] = 0;
      
      state.exampleClickCount[id]++;
      
      card.classList.remove('show-math', 'show-interval');
      
      if (state.exampleClickCount[id] % 3 === 1) {
        card.classList.add('show-math');
      } else if (state.exampleClickCount[id] % 3 === 2) {
        card.classList.add('show-interval');
      }
    }

    // Initialize example canvases
    function drawExamples() {
      const examples = [
        { id: 'ex-inc', func: drawIncreasing },
        { id: 'ex-dec', func: drawDecreasing },
        { id: 'ex-cup', func: drawConcaveUp },
        { id: 'ex-cdown', func: drawConcaveDown },
        { id: 'ex-jump', func: drawJumpUp },
        { id: 'ex-inflect', func: drawInflection },
        { id: 'ex-vert', func: drawVerticalAsymptote },
        { id: 'ex-horiz', func: drawHorizontalAsymptote }
      ];

      examples.forEach(ex => {
        const canvas = document.getElementById(ex.id);
        if (canvas) {
          const ctx = canvas.getContext('2d');
          canvas.width = canvas.offsetWidth;
          canvas.height = canvas.offsetHeight;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ex.func(ctx, canvas.width, canvas.height);
        }
      });
    }

    // Initialize control cards for Tab 3
    function drawControlCards() {
      const controls = [
        { id: 'ctrl-inc', func: drawIncreasing },
        { id: 'ctrl-dec', func: drawDecreasing },
        { id: 'ctrl-const', func: drawConstant },
        { id: 'ctrl-cup', func: drawConcaveUp },
        { id: 'ctrl-cdown', func: drawConcaveDown },
        { id: 'ctrl-linear', func: drawLinear },
        { id: 'ctrl-inflection', func: drawInflection },
        { id: 'ctrl-jump-up', func: drawJumpUp },
        { id: 'ctrl-jump-down', func: drawJumpDown },
        { id: 'ctrl-vasym', func: drawVerticalAsymptote },
        { id: 'ctrl-hasym', func: drawHorizontalAsymptote }
      ];

      controls.forEach(ctrl => {
        const canvas = document.getElementById(ctrl.id);
        if (canvas) {
          const ctx = canvas.getContext('2d');
          canvas.width = 60;
          canvas.height = 45;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctrl.func(ctx, canvas.width, canvas.height);
        }
      });
    }

    // Toggle bracket open/closed
    function toggleBracket(side) {
      const btn = document.getElementById(`${side}-bracket`);
      if (side === 'left') {
        state.intervalBuilder.leftBracket = state.intervalBuilder.leftBracket === 'open' ? 'closed' : 'open';
        btn.textContent = state.intervalBuilder.leftBracket === 'open' ? '(' : '[';
      } else {
        state.intervalBuilder.rightBracket = state.intervalBuilder.rightBracket === 'open' ? 'closed' : 'open';
        btn.textContent = state.intervalBuilder.rightBracket === 'open' ? ')' : ']';
      }
      btn.classList.toggle('closed');
    }

    // Toggle infinity
    function toggleInfinity(side) {
      const checkbox = document.getElementById(`${side}-infinity`);
      const input = document.getElementById(`${side}-value`);
      
      if (side === 'left') {
        state.intervalBuilder.leftInfinity = checkbox.checked;
        input.disabled = checkbox.checked;
        input.style.opacity = checkbox.checked ? '0.3' : '1';
        if (checkbox.checked) {
          // Open bracket for infinity
          state.intervalBuilder.leftBracket = 'open';
          const btn = document.getElementById('left-bracket');
          btn.textContent = '(';
          btn.classList.remove('closed');
        }
      } else {
        state.intervalBuilder.rightInfinity = checkbox.checked;
        input.disabled = checkbox.checked;
        input.style.opacity = checkbox.checked ? '0.3' : '1';
        if (checkbox.checked) {
          // Open bracket for infinity
          state.intervalBuilder.rightBracket = 'open';
          const btn = document.getElementById('right-bracket');
          btn.textContent = ')';
          btn.classList.remove('closed');
        }
      }
    }

    // Add custom interval
    function addCustomInterval() {
      const leftValue = state.intervalBuilder.leftInfinity ? -Infinity : parseFloat(document.getElementById('left-value').value);
      const rightValue = state.intervalBuilder.rightInfinity ? Infinity : parseFloat(document.getElementById('right-value').value);
      
      if (!state.intervalBuilder.leftInfinity && !state.intervalBuilder.rightInfinity) {
        if (isNaN(leftValue) || isNaN(rightValue)) {
          alert('Please enter valid numbers');
          return;
        }
        if (leftValue >= rightValue) {
          alert('Left value must be less than right value');
          return;
        }
      }
      
      const leftBracket = state.intervalBuilder.leftBracket === 'open' ? '(' : '[';
      const rightBracket = state.intervalBuilder.rightBracket === 'open' ? ')' : ']';
      const leftText = state.intervalBuilder.leftInfinity ? '-∞' : leftValue;
      const rightText = state.intervalBuilder.rightInfinity ? '∞' : rightValue;
      
      const intervalText = `${leftBracket}${leftText}, ${rightText}${rightBracket}`;
      
      addIntervalToList(intervalText, leftValue, rightValue, 'interval');
    }

    // Add point
    function addPoint() {
      const value = parseFloat(document.getElementById('point-value').value);
      if (isNaN(value)) {
        alert('Please enter a valid number');
        return;
      }
      
      const intervalText = `x = ${value}`;
      addIntervalToList(intervalText, value, value, 'point');
    }

    // Set preset interval
    function setPresetInterval(preset) {
      switch(preset) {
        case 'ninf-0':
          document.getElementById('left-infinity').checked = true;
          document.getElementById('right-infinity').checked = false;
          document.getElementById('right-value').value = '0';
          toggleInfinity('left');
          toggleInfinity('right');
          addCustomInterval();
          break;
        case '0-inf':
          document.getElementById('left-infinity').checked = false;
          document.getElementById('right-infinity').checked = true;
          document.getElementById('left-value').value = '0';
          toggleInfinity('left');
          toggleInfinity('right');
          addCustomInterval();
          break;
        case 'full':
          document.getElementById('left-infinity').checked = true;
          document.getElementById('right-infinity').checked = true;
          toggleInfinity('left');
          toggleInfinity('right');
          addCustomInterval();
          break;
        case '-1-1':
          document.getElementById('left-infinity').checked = false;
          document.getElementById('right-infinity').checked = false;
          document.getElementById('left-value').value = '-1';
          document.getElementById('right-value').value = '1';
          state.intervalBuilder.leftBracket = 'closed';
          state.intervalBuilder.rightBracket = 'closed';
          document.getElementById('left-bracket').textContent = '[';
          document.getElementById('left-bracket').classList.add('closed');
          document.getElementById('right-bracket').textContent = ']';
          document.getElementById('right-bracket').classList.add('closed');
          toggleInfinity('left');
          toggleInfinity('right');
          addCustomInterval();
          break;
        case 'point-0':
          document.getElementById('point-value').value = '0';
          addPoint();
          break;
      }
    }

    // Add interval to list
    function addIntervalToList(intervalText, start, end, type) {
      const listContainer = document.getElementById('interval-list');
      
      // Remove placeholder if exists
      const placeholder = listContainer.querySelector('.placeholder-text');
      if (placeholder) placeholder.remove();
      
      const intervalId = 'interval-' + Date.now();
      const intervalItem = document.createElement('div');
      intervalItem.className = 'interval-item';
      intervalItem.id = intervalId;
      intervalItem.dataset.start = start;
      intervalItem.dataset.end = end;
      intervalItem.dataset.type = type;
      intervalItem.onclick = () => selectInterval(intervalId);
      
      intervalItem.innerHTML = `
        <span class="interval-text">${intervalText}</span>
        <canvas></canvas>
        <button class="remove-btn" onclick="removeInterval('${intervalId}'); event.stopPropagation();">×</button>
      `;
      
      listContainer.appendChild(intervalItem);
      
      // Add to state
      state.buildIntervals.push({
        id: intervalId,
        type: type,
        start: start,
        end: end,
        text: intervalText,
        behaviors: []
      });
      
      // Draw generic curve
      setTimeout(() => {
        const canvas = intervalItem.querySelector('canvas');
        drawIntervalCurve(canvas, intervalId);
      }, 10);
      
      updateBuildGraph();
    }

    // Create word card for Tab 2
    function createWordCard(type) {
      const card = document.createElement('div');
      card.className = 'word-card';
      card.dataset.type = type.id;
      card.draggable = true;
      card.textContent = type.label;
      
      card.addEventListener('click', () => {
        if (card.parentElement.classList.contains('sequence-container')) {
          // Remove from sequence
          const idx = state.readSequence.indexOf(type.id);
          if (idx > -1) state.readSequence.splice(idx, 1);
          card.remove();
          
          // Restore placeholder if empty
          const container = document.getElementById('read-sequence');
          if (container.children.length === 0) {
            const placeholder = document.createElement('div');
            placeholder.className = 'placeholder-text';
            placeholder.textContent = 'Drag word cards here or click selected cards to remove';
            container.appendChild(placeholder);
          }
        } else {
          // Toggle selection in bank
          card.classList.toggle('selected');
        }
      });
      
      card.addEventListener('dragstart', handleDragStart);
      card.addEventListener('dragend', handleDragEnd);
      
      return card;
    }

    // Drag and drop handlers
    function handleDragStart(e) {
      const card = e.target;
      state.draggedCard = {
        type: card.dataset.type,
        element: card,
        fromSequence: card.parentElement.classList.contains('sequence-container')
      };
      card.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragEnd(e) {
      e.target.classList.remove('dragging');
      state.draggedCard = null;
    }

    function handleDragOver(e) {
      if (e.preventDefault) {
        e.preventDefault();
      }
      e.dataTransfer.dropEffect = 'move';
      return false;
    }

    function handleDragEnter(e) {
      if (e.target.classList.contains('sequence-container')) {
        e.target.classList.add('drag-over');
      }
    }

    function handleDragLeave(e) {
      if (e.target.classList.contains('sequence-container')) {
        e.target.classList.remove('drag-over');
      }
    }

    function handleDrop(e) {
      if (e.stopPropagation) {
        e.stopPropagation();
      }
      
      const container = document.getElementById('read-sequence');
      container.classList.remove('drag-over');
      
      if (!state.draggedCard) return false;
      
      const placeholder = container.querySelector('.placeholder-text');
      if (placeholder) {
        placeholder.remove();
      }
      
      if (state.draggedCard.fromSequence) {
        // Remove from original position
        const idx = state.readSequence.indexOf(state.draggedCard.type);
        if (idx > -1) state.readSequence.splice(idx, 1);
        state.draggedCard.element.remove();
      }
      
      // Add to sequence
      const typeObj = behaviorTypes.find(t => t.id === state.draggedCard.type);
      if (typeObj) {
        const newCard = createWordCard(typeObj);
        container.appendChild(newCard);
        state.readSequence.push(state.draggedCard.type);
      }
      
      return false;
    }

    // Initialize Read tab
    function initializeReadTab() {
      const container = document.getElementById('read-cards');
      container.innerHTML = '';
      
      behaviorTypes.forEach(type => {
        const card = createWordCard(type);
        container.appendChild(card);
      });
      
      const sequence = document.getElementById('read-sequence');
      sequence.addEventListener('dragover', handleDragOver);
      sequence.addEventListener('drop', handleDrop);
      sequence.addEventListener('dragenter', handleDragEnter);
      sequence.addEventListener('dragleave', handleDragLeave);
      
      generateNewReadProblem();
    }

    // Select interval for behavior modification
    function selectInterval(intervalId) {
      // Clear previous selection
      document.querySelectorAll('.interval-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // Set new selection
      document.getElementById(intervalId).classList.add('selected');
      state.selectedInterval = intervalId;
      
      // Update control cards to show active behaviors
      const interval = state.buildIntervals.find(i => i.id === intervalId);
      document.querySelectorAll('.control-card').forEach(card => {
        card.classList.remove('active');
        if (interval && interval.behaviors.includes(card.dataset.behavior)) {
          card.classList.add('active');
        }
      });
    }

    // Remove interval
    function removeInterval(intervalId) {
      const idx = state.buildIntervals.findIndex(i => i.id === intervalId);
      if (idx > -1) state.buildIntervals.splice(idx, 1);
      
      document.getElementById(intervalId).remove();
      
      if (state.selectedInterval === intervalId) {
        state.selectedInterval = null;
      }
      
      // Restore placeholder if empty
      const container = document.getElementById('interval-list');
      if (container.children.length === 0) {
        container.innerHTML = '<div class="placeholder-text">Use the interval builder above to add segments</div>';
      }
      
      updateBuildGraph();
    }

    // Toggle behavior on selected interval
    function toggleBehavior(card) {
      if (!state.selectedInterval) {
        alert('Please select an interval first');
        return;
      }
      
      const interval = state.buildIntervals.find(i => i.id === state.selectedInterval);
      if (!interval) return;
      
      const behavior = card.dataset.behavior;
      const idx = interval.behaviors.indexOf(behavior);
      
      if (idx > -1) {
        // Remove behavior
        interval.behaviors.splice(idx, 1);
        card.classList.remove('active');
      } else {
        // Add behavior, but check for conflicts
        if (behavior === 'increasing' || behavior === 'decreasing' || behavior === 'constant') {
          // Remove other direction behaviors
          interval.behaviors = interval.behaviors.filter(b => 
            b !== 'increasing' && b !== 'decreasing' && b !== 'constant'
          );
          document.querySelectorAll('.control-card[data-behavior="increasing"], .control-card[data-behavior="decreasing"], .control-card[data-behavior="constant"]')
            .forEach(c => c.classList.remove('active'));
        }
        
        if (behavior === 'concave-up' || behavior === 'concave-down' || behavior === 'linear') {
          // Remove other curvature behaviors
          interval.behaviors = interval.behaviors.filter(b => 
            b !== 'concave-up' && b !== 'concave-down' && b !== 'linear'
          );
          document.querySelectorAll('.control-card[data-behavior="concave-up"], .control-card[data-behavior="concave-down"], .control-card[data-behavior="linear"]')
            .forEach(c => c.classList.remove('active'));
        }
        
        interval.behaviors.push(behavior);
        card.classList.add('active');
      }
      
      // Redraw interval curve
      const intervalElement = document.getElementById(state.selectedInterval);
      const canvas = intervalElement.querySelector('canvas');
      drawIntervalCurve(canvas, state.selectedInterval);
      
      updateBuildGraph();
    }

    // Draw interval curve based on behaviors
    function drawIntervalCurve(canvas, intervalId) {
      const interval = state.buildIntervals.find(i => i.id === intervalId);
      if (!interval) return;
      
      const ctx = canvas.getContext('2d');
      canvas.width = canvas.offsetWidth || 200;
      canvas.height = 40;
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      const w = canvas.width;
      const h = canvas.height;
      
      // Default generic curve
      ctx.strokeStyle = '#0f766e';
      ctx.lineWidth = 2;
      ctx.beginPath();
      
      // Apply behaviors
      const isIncreasing = interval.behaviors.includes('increasing');
      const isDecreasing = interval.behaviors.includes('decreasing');
      const isConstant = interval.behaviors.includes('constant');
      const isConcaveUp = interval.behaviors.includes('concave-up');
      const isConcaveDown = interval.behaviors.includes('concave-down');
      const isLinear = interval.behaviors.includes('linear');
      
      if (interval.type === 'point') {
        // Draw point or special feature
        if (interval.behaviors.includes('jump-up')) {
          drawJumpUp(ctx, w, h);
        } else if (interval.behaviors.includes('jump-down')) {
          drawJumpDown(ctx, w, h);
        } else if (interval.behaviors.includes('inflection')) {
          drawInflection(ctx, w, h);
        } else {
          // Just a point
          ctx.beginPath();
          ctx.arc(w/2, h/2, 4, 0, 2 * Math.PI);
          ctx.fillStyle = '#0f766e';
          ctx.fill();
        }
      } else {
        // Draw curve segment
        if (isConstant) {
          ctx.moveTo(10, h/2);
          ctx.lineTo(w - 10, h/2);
        } else if (isIncreasing) {
          if (isConcaveUp) {
            ctx.moveTo(10, h - 10);
            ctx.quadraticCurveTo(w/2, h - 5, w - 10, 10);
          } else if (isConcaveDown) {
            ctx.moveTo(10, h - 10);
            ctx.quadraticCurveTo(w/2, 5, w - 10, 10);
          } else {
            ctx.moveTo(10, h - 10);
            ctx.lineTo(w - 10, 10);
          }
        } else if (isDecreasing) {
          if (isConcaveUp) {
            ctx.moveTo(10, 10);
            ctx.quadraticCurveTo(w/2, h - 5, w - 10, h - 10);
          } else if (isConcaveDown) {
            ctx.moveTo(10, 10);
            ctx.quadraticCurveTo(w/2, 5, w - 10, h - 10);
          } else {
            ctx.moveTo(10, 10);
            ctx.lineTo(w - 10, h - 10);
          }
        } else {
          // Generic curve (no direction specified)
          if (isConcaveUp) {
            ctx.moveTo(10, h/2);
            ctx.quadraticCurveTo(w/2, h - 5, w - 10, h/2);
          } else if (isConcaveDown) {
            ctx.moveTo(10, h/2);
            ctx.quadraticCurveTo(w/2, 5, w - 10, h/2);
          } else {
            // Default wavy line
            ctx.moveTo(10, h/2);
            ctx.bezierCurveTo(w/3, h/3, w*2/3, h*2/3, w - 10, h/2);
          }
        }
        ctx.stroke();
        
        // Draw asymptotes if specified
        if (interval.behaviors.includes('v-asymptote')) {
          ctx.strokeStyle = '#dc2626';
          ctx.setLineDash([4, 4]);
          ctx.beginPath();
          ctx.moveTo(w - 20, 5);
          ctx.lineTo(w - 20, h - 5);
          ctx.stroke();
          ctx.setLineDash([]);
        }
        
        if (interval.behaviors.includes('h-asymptote')) {
          ctx.strokeStyle = '#dc2626';
          ctx.setLineDash([4, 4]);
          ctx.beginPath();
          ctx.moveTo(10, 10);
          ctx.lineTo(w - 10, 10);
          ctx.stroke();
          ctx.setLineDash([]);
        }
      }
    }

    // Update build graph preview
    function updateBuildGraph() {
      const canvas = document.getElementById('build-graph');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      canvas.width = canvas.offsetWidth || 800;
      canvas.height = 350;
      
      const w = canvas.width;
      const h = canvas.height;
      
      ctx.clearRect(0, 0, w, h);
      drawGrid(ctx, w, h);
      
      if (state.buildIntervals.length === 0) return;
      
      // Sort intervals by start value
      const sorted = [...state.buildIntervals].sort((a, b) => {
        if (a.start === -Infinity) return -1;
        if (b.start === -Infinity) return 1;
        return a.start - b.start;
      });
      
      ctx.save();
      ctx.strokeStyle = '#0f766e';
      ctx.lineWidth = 3;
      
      // Draw each interval
      sorted.forEach(interval => {
        // Map interval to canvas coordinates
        // This is simplified - you'd need proper scaling
        const startX = interval.start === -Infinity ? 50 : w/2 + interval.start * 100;
        const endX = interval.end === Infinity ? w - 50 : w/2 + interval.end * 100;
        
        if (interval.type === 'point') {
          // Draw point features
          const x = w/2 + interval.start * 100;
          
          if (interval.behaviors.includes('inflection')) {
            ctx.fillStyle = '#f59e0b';
            ctx.beginPath();
            ctx.arc(x, h/2, 6, 0, 2 * Math.PI);
            ctx.fill();
          } else if (interval.behaviors.includes('jump-up') || interval.behaviors.includes('jump-down')) {
            // Draw jump discontinuity
            // Simplified - would need to connect with adjacent segments
          }
        } else {
          // Draw curve segment
          ctx.beginPath();
          
          const isIncreasing = interval.behaviors.includes('increasing');
          const isDecreasing = interval.behaviors.includes('decreasing');
          const isConstant = interval.behaviors.includes('constant');
          const isConcaveUp = interval.behaviors.includes('concave-up');
          const isConcaveDown = interval.behaviors.includes('concave-down');
          
          let startY = h/2;
          let endY = h/2;
          
          if (isIncreasing) {
            startY = h * 0.7;
            endY = h * 0.3;
          } else if (isDecreasing) {
            startY = h * 0.3;
            endY = h * 0.7;
          }
          
          if (isConstant) {
            ctx.moveTo(startX, h/2);
            ctx.lineTo(endX, h/2);
          } else if (isConcaveUp || isConcaveDown) {
            ctx.moveTo(startX, startY);
            const midX = (startX + endX) / 2;
            const midY = isConcaveUp ? startY + 20 : startY - 20;
            ctx.quadraticCurveTo(midX, midY, endX, endY);
          } else {
            ctx.moveTo(startX, startY);
            ctx.lineTo(endX, endY);
          }
          
          ctx.stroke();
        }
      });
      
      ctx.restore();
    }

    // Clear build workspace
    function clearBuildWorkspace() {
      state.buildIntervals = [];
      state.selectedInterval = null;
      document.getElementById('interval-list').innerHTML = '<div class="placeholder-text">Use the interval builder above to add segments</div>';
      document.querySelectorAll('.control-card').forEach(card => {
        card.classList.remove('active');
      });
      updateBuildGraph();
    }

    // Read problems
    const readProblems = [
      { 
        sequence: ['increasing', 'concave-up'], 
        intervals: [['(-∞', '∞)'], ['(-∞', '∞)']],
        description: 'Increasing and concave up everywhere' 
      },
      { 
        sequence: ['decreasing', 'concave-down', 'inflection', 'decreasing', 'concave-up'], 
        intervals: [['(-∞', '0)'], ['(-∞', '0)'], ['x=0'], ['(0', '∞)'], ['(0', '∞)']],
        description: 'Decreasing with inflection at x=0' 
      },
      { 
        sequence: ['constant', 'jump-up', 'increasing'], 
        intervals: [['(-∞', '0)'], ['x=0'], ['(0', '∞)']],
        description: 'Constant then jump up, then increasing' 
      }
    ];

    // Generate new Read problem
    function generateNewReadProblem() {
      state.readProblem = readProblems[Math.floor(Math.random() * readProblems.length)];
      state.hintCount = 0;
      drawReadGraph();
      clearReadSequence();
    }

    // Draw the graph for Read tab
    function drawReadGraph() {
      const canvas = document.getElementById('read-graph');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      canvas.width = canvas.offsetWidth || 800;
      canvas.height = 350;
      
      const w = canvas.width;
      const h = canvas.height;
      
      ctx.clearRect(0, 0, w, h);
      drawGrid(ctx, w, h);
      
      // Draw based on problem
      ctx.save();
      ctx.strokeStyle = '#0f766e';
      ctx.lineWidth = 3;
      
      const problem = state.readProblem;
      
      if (problem.description.includes('everywhere')) {
        ctx.beginPath();
        ctx.moveTo(50, h - 50);
        for (let x = 50; x < w - 50; x += 5) {
          const t = (x - 50) / (w - 100);
          const y = h - 50 - 200 * Math.pow(t, 2);
          ctx.lineTo(x, Math.max(50, y));
        }
        ctx.stroke();
      } else if (problem.description.includes('inflection')) {
        ctx.beginPath();
        for (let x = 50; x < w - 50; x += 5) {
          const t = (x - w/2) / 150;
          const y = h/2 - 100 * Math.tanh(t);
          if (x === 50) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.stroke();
        ctx.fillStyle = '#f59e0b';
        ctx.beginPath();
        ctx.arc(w/2, h/2, 6, 0, 2 * Math.PI);
        ctx.fill();
      } else if (problem.description.includes('jump')) {
        ctx.beginPath();
        ctx.moveTo(50, h * 0.6);
        ctx.lineTo(w/2 - 10, h * 0.6);
        ctx.stroke();
        ctx.beginPath();
        ctx.arc(w/2 - 10, h * 0.6, 5, 0, 2 * Math.PI);
        ctx.fillStyle = 'white';
        ctx.fill();
        ctx.stroke();
        ctx.beginPath();
        ctx.arc(w/2 + 10, h * 0.4, 5, 0, 2 * Math.PI);
        ctx.fillStyle = '#0f766e';
        ctx.fill();
        ctx.beginPath();
        ctx.moveTo(w/2 + 10, h * 0.4);
        ctx.lineTo(w - 50, h * 0.2);
        ctx.stroke();
      }
      
      ctx.restore();
    }

    // Draw grid
    function drawGrid(ctx, w, h) {
      ctx.strokeStyle = '#e8e8e8';
      ctx.lineWidth = 1;
      
      for (let x = 0; x <= w; x += 50) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, h);
        ctx.stroke();
      }
      
      for (let y = 0; y <= h; y += 50) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(w, y);
        ctx.stroke();
      }
      
      ctx.strokeStyle = '#666';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(w/2, 0);
      ctx.lineTo(w/2, h);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(0, h/2);
      ctx.lineTo(w, h/2);
      ctx.stroke();
    }

    // Clear read sequence
    function clearReadSequence() {
      const container = document.getElementById('read-sequence');
      container.innerHTML = '<div class="placeholder-text">Drag word cards here or click selected cards to remove</div>';
      state.readSequence = [];
      document.getElementById('read-feedback').classList.remove('show');
      document.getElementById('sentence-display').innerHTML = '';
    }

    // Get hint for Read tab
    function getHint() {
      const feedback = document.getElementById('read-feedback');
      state.hintCount++;
      
      if (state.hintCount === 1) {
        feedback.className = 'feedback info show';
        feedback.textContent = `Hint: Look for ${state.readProblem.sequence.length} behaviors in the graph.`;
      } else if (state.hintCount === 2) {
        feedback.className = 'feedback info show';
        feedback.textContent = `Hint: The first behavior is "${state.readProblem.sequence[0].replace(/-/g, ' ')}".`;
      } else {
        feedback.className = 'feedback info show';
        const labels = state.readProblem.sequence.map(s => 
          behaviorTypes.find(t => t.id === s)?.label || s
        );
        feedback.textContent = `Answer: ${labels.join(' → ')}`;
      }
    }

    // Check Read answer
    function checkReadAnswer() {
      const feedback = document.getElementById('read-feedback');
      const sentenceDisplay = document.getElementById('sentence-display');
      
      if (state.readSequence.length === 0) {
        feedback.className = 'feedback error show';
        feedback.textContent = 'Please add behavior cards first.';
        return;
      }
      
      const correct = JSON.stringify(state.readSequence) === JSON.stringify(state.readProblem.sequence);
      
      if (correct) {
        feedback.className = 'feedback success show';
        feedback.textContent = 'Excellent! You correctly identified all behaviors!';
        
        const sentence = generateSentence(state.readProblem);
        sentenceDisplay.className = 'sentence-display';
        sentenceDisplay.innerHTML = `<strong>Complete Description:</strong><br>${sentence}`;
        
        const cards = document.querySelectorAll('#read-sequence .word-card');
        cards.forEach((card, i) => {
          setTimeout(() => {
            card.style.transform = 'scale(1.1)';
            card.style.background = 'linear-gradient(135deg, #10b981, #0f766e)';
            card.style.color = 'white';
          }, i * 100);
        });
      } else {
        feedback.className = 'feedback error show';
        const missing = state.readProblem.sequence.length - state.readSequence.length;
        if (missing > 0) {
          feedback.textContent = `You're missing ${missing} behavior(s).`;
        } else if (missing < 0) {
          feedback.textContent = `Too many behaviors. You have ${-missing} extra card(s).`;
        } else {
          feedback.textContent = 'Not quite right. Check the order.';
        }
        sentenceDisplay.innerHTML = '';
      }
    }

    // Generate sentence from sequence
    function generateSentence(problem) {
      let sentence = "The function ";
      const behaviors = problem.sequence;
      const intervals = problem.intervals;
      
      behaviors.forEach((behavior, i) => {
        if (i > 0) sentence += ", ";
        
        const interval = intervals[i];
        const intervalStr = interval ? interval.join(', ') : "";
        
        const typeObj = behaviorTypes.find(t => t.id === behavior);
        const label = typeObj ? typeObj.label.toLowerCase() : behavior;
        
        if (behavior === 'inflection') {
          sentence += `has an inflection point at ${intervalStr}`;
        } else if (behavior.includes('jump')) {
          sentence += `has a ${label} discontinuity at ${intervalStr}`;
        } else if (behavior.includes('asymptote')) {
          sentence += `approaches a ${label} at ${intervalStr}`;
        } else {
          sentence += `is ${label} on ${intervalStr}`;
        }
      });
      
      sentence += ".";
      return sentence;
    }

    // Build challenges
    const buildChallenges = [
      {
        description: "A function that is increasing and concave up"
      },
      {
        description: "A function that is decreasing concave up, then increasing concave up"
      },
      {
        description: "A function that is constant, has a jump up discontinuity, then is increasing"
      },
      {
        description: "A function that is increasing concave up, has an inflection point, then is increasing concave down"
      },
      {
        description: "A function that is decreasing concave down, has an inflection point, then is increasing concave up"
      }
    ];

    // Generate new Build challenge
    function generateNewBuildChallenge() {
      state.buildChallenge = buildChallenges[Math.floor(Math.random() * buildChallenges.length)];
      document.getElementById('build-challenge').textContent = state.buildChallenge.description;
      clearBuildWorkspace();
    }

    // Initialize Build tab
    function initializeBuildTab() {
      generateNewBuildChallenge();
      drawControlCards();
      updateBuildGraph();
    }

    // AI Integration
    async function callAI(prompt) {
      try {
        const response = await fetch('/api/gemini', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            contents: [{ 
              role: "user", 
              parts: [{ text: prompt }] 
            }] 
          })
        });
        
        if (!response.ok) return null;
        
        const data = await response.json();
        return data.candidates?.[0]?.content?.parts?.[0]?.text;
      } catch (error) {
        console.error('AI Error:', error);
        return null;
      }
    }

    async function checkBuildAnswer() {
      const feedback = document.getElementById('build-feedback');
      
      if (state.buildIntervals.length === 0) {
        feedback.className = 'feedback error show';
        feedback.textContent = 'Please add intervals and behaviors first.';
        return;
      }
      
      // Build description of what student created
      const description = state.buildIntervals.map(interval => {
        const behaviors = interval.behaviors.join(' and ');
        return `${interval.text}: ${behaviors || 'generic curve'}`;
      }).join(', ');
      
      const prompt = `Challenge: "${state.buildChallenge.description}"
Student built: ${description}

Check if this matches the challenge mathematically. Consider:
- A generic curve with no behaviors specified might already satisfy some requirements
- "Increasing and concave up" can be one interval with both properties
- The intervals should cover the appropriate domain

Respond with:
- "Correct!" if it matches
- "Missing: [specific behavior or interval]" if incomplete
- "Incorrect: [specific issue]" if wrong

Keep response under 20 words.`;

      feedback.className = 'feedback info show';
      feedback.textContent = 'Checking...';
      
      const aiResponse = await callAI(prompt);
      
      if (aiResponse) {
        if (aiResponse.toLowerCase().includes('correct')) {
          feedback.className = 'feedback success show';
        } else if (aiResponse.toLowerCase().includes('missing')) {
          feedback.className = 'feedback info show';
        } else {
          feedback.className = 'feedback error show';
        }
        feedback.textContent = aiResponse;
      } else {
        feedback.className = 'feedback info show';
        feedback.textContent = 'AI unavailable. Check if your construction matches the description.';
      }
    }

    // Tab management
    function switchToTab(tabName) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.tab === tabName) {
          btn.classList.add('active');
        }
      });
      
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      document.getElementById(tabName).classList.add('active');
      
      if (tabName === 'intro') {
        setTimeout(drawExamples, 50);
      } else if (tabName === 'read') {
        initializeReadTab();
      } else if (tabName === 'build') {
        initializeBuildTab();
      }
    }

    function setupTabs() {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          switchToTab(btn.dataset.tab);
        });
      });
    }

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      setupTabs();
      drawExamples();
    });
  </script>
</body>
</html>
